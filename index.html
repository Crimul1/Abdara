<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Calendario de Asistencia Abdara12</title>

<!-- FONTS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

<!-- FULLCALENDAR -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>

<style>
/* =========================
      PALETA & BASE
   ========================= */
:root{
  --font-title:'UnifrakturCook',cursive;
  --font-body:'Roboto',sans-serif;

  --color-bg:#0a0a0a;
  --color-header:#121212;
  --color-side:#121212;
  --color-card:#161616;
  --color-border:#262626;

  --txt-main:#ededed;
  --txt-dim:#a9a9a9;

  --neon-p:#8d3aff;
  --neon-k:#ff38c7;
  --neon-dark:#30005b;

  --h:72px;
  --w:270px;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:var(--font-body);
  background:var(--color-bg);
  color:var(--txt-main);
  overflow:hidden;
}

/* GRID */
#app{
  display:grid;
  grid-template-columns:var(--w) 1fr;
  grid-template-rows:var(--h) 1fr;
  grid-template-areas:"h h" "s m";
  height:100vh;
}

/* =========================
      HEADER
   ========================= */
header{
  grid-area:h;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  background:var(--color-header);
  border-bottom:1px solid var(--color-border);
}

.title{
  font-family:var(--font-title);
  font-size:clamp(1.6rem,2vw+1rem,2.6rem);
  background:linear-gradient(90deg,var(--neon-p),var(--neon-k));
  -webkit-background-clip:text;
  color:transparent;
  -webkit-text-fill-color:transparent;
  filter:drop-shadow(0 0 6px rgba(141,58,255,.6))
         drop-shadow(0 0 14px rgba(255,56,199,.35));
}

/* ICONO MENU MOVIL */
#btnMenu{
  display:none;
  background:none;
  border:none;
  color:white;
  font-size:1.7rem;
  cursor:pointer;
}

/* =========================
      SIDEBAR
   ========================= */
aside{
  grid-area:s;
  padding:16px;
  background:var(--color-side);
  border-right:1px solid var(--color-border);
}

.nav{list-style:none;padding:0;display:flex;flex-direction:column;gap:8px;}
.nav a{
  display:block;
  padding:12px;
  background:#131313;
  border:1px solid var(--color-border);
  border-radius:10px;
  color:var(--txt-dim);
  cursor:pointer;
  transition:0.25s;
  text-decoration:none;
}
.nav a.active, .nav a:hover{
  background:var(--neon-dark);
  color:white;
  box-shadow:0 0 12px var(--neon-p);
}

/* =========================
      MAIN
   ========================= */
main{
  grid-area:m;
  position:relative;
  height:calc(100vh - var(--h));
  overflow:hidden;
  background:
    radial-gradient(900px 700px at 10% -10%,rgba(141,58,255,.12),transparent 60%),
    radial-gradient(900px 700px at 110% 0%,rgba(255,56,199,.12),transparent 60%);
}

.view{
  display:none;
  height:100%;
}
.view.active{
  display:block;
  animation:fade .25s ease;
}

.card{
  background:var(--color-card);
  border:1px solid var(--color-border);
  border-radius:14px;
  padding:14px;
  height:100%;
  display:flex;
  flex-direction:column;
}

@keyframes fade{from{opacity:0}to{opacity:1}}

#calendarWrap{flex:1;display:flex;flex-direction:column;min-height:0;}
#calendar{flex:1;min-height:0;}

/* FULLCALENDAR */
.fc{--fc-border-color:var(--color-border);}
.fc .fc-toolbar-title{font-family:var(--font-title);color:white;text-shadow:0 0 10px var(--neon-p);}
.fc .fc-button{background:var(--neon-dark)!important;border:none!important;color:white!important;transition:.25s;}
.fc .fc-button:hover{background:var(--neon-p)!important;box-shadow:0 0 10px var(--neon-p);}
.fc-daygrid-day-number{color:var(--txt-main);}
.fc-col-header-cell-cushion{color:var(--txt-dim);}
.fc-theme-standard td,.fc-theme-standard th{border-color:var(--color-border);}
.fc-day-today{background:#1a1220!important;}

.fc-day-with-stream{
  background:#240146!important;
  transition:.25s;
}
.fc-day-with-stream:hover{
  background:#43007a!important;
  box-shadow:inset 0 0 12px var(--neon-p);
}

/* =========================
      TOP ASISTENCIAS
   ========================= */
.list{
  list-style:none;
  display:grid;
  grid-template-columns:1fr auto;
  gap:10px;
  padding:0;
  margin-top:10px;
  overflow-y:auto;
}

/* =========================
      RESPONSIIVE
   ========================= */
@media(max-width:900px){
  :root{--w:0}

  #app{
    grid-template-columns:1fr;
    grid-template-areas:"h" "m";
  }

  aside{
    position:fixed;
    top:var(--h);
    left:0;
    width:200px;
    height:calc(100vh - var(--h));
    display:none;
    z-index:99;
  }

  #btnMenu{
    display:block;
  }
}
</style>
</head>

<body>
<div id="app">

  <!-- HEADER -->
  <header>
    <h1 class="title">Calendario de Asistencia Abdara12</h1>
    <button id="btnMenu">â˜°</button>
  </header>

  <!-- SIDEBAR -->
  <aside id="side">
    <ul class="nav">
      <li><a id="nav-cal" class="active">Calendario</a></li>
      <li><a id="nav-top">Top Asistencias</a></li>
    </ul>
  </aside>

  <!-- MAIN -->
  <main>

    <!-- VISTA CALENDARIO -->
    <section id="view-cal" class="view active">
      <div class="card">
        <div id="calendarWrap"><div id="calendar"></div></div>
      </div>
    </section>

    <!-- VISTA TOP -->
    <section id="view-top" class="view">
      <div class="card">
        <h2 class="title" style="font-size:2rem">Top Asistencias</h2>
        <ul id="listTop" class="list"></ul>
      </div>
    </section>

  </main>

</div>

<script>
/* =========================
      CONSTANTES
   ========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbx6WjqODhuetXMwsAtzfvXY539Quj1exnRz7s7J6FQBH2UAlag6Brs6InxPsRS3uq2F/exec?webAction=get_all_data";
const TIMEZONE="America/Guatemala";

/* =========================
      ESTADO
   ========================= */
let DATA={asistencia:[],streams:{}};
let calendar=null;
let mobileOpen=false;

/* =========================
      UTIL
   ========================= */
const $=e=>document.querySelector(e);

/* =========================
      NAV
   ========================= */
function show(v){
  $("#view-cal").classList.remove("active");
  $("#view-top").classList.remove("active");
  $("#nav-cal").classList.remove("active");
  $("#nav-top").classList.remove("active");

  if(v==="cal"){
    $("#view-cal").classList.add("active");
    $("#nav-cal").classList.add("active");
    renderCalendar();
  }
  if(v==="top"){
    $("#view-top").classList.add("active");
    $("#nav-top").classList.add("active");
    renderTop();
  }
}

/* =========================
      FETCH DATA
   ========================= */
async function refreshData(){
  try{
    const r=await fetch(API_URL+"&t="+Date.now());
    const j=await r.json();
    DATA.asistencia=j.asistencia.filter(a=>a[1]);
    DATA.streams=j.streams||{};
  }catch(e){
    console.warn("Error cargando datos");
  }
}

/* =========================
      CALENDARIO
   ========================= */
function destroyCalendar(){
  if(calendar){
    try{calendar.destroy();}catch(e){}
    calendar=null;
  }
}

function renderCalendar(){
  destroyCalendar();

  calendar=new FullCalendar.Calendar($("#calendar"),{
    initialView:"dayGridMonth",
    timeZone:TIMEZONE,
    locale:"es",
    headerToolbar:{left:"prev,next today",center:"title"},
    dayCellDidMount(info){
      const d=info.date.toISOString().split("T")[0];
      if(DATA.streams[d]) info.el.classList.add("fc-day-with-stream");
    },
    dateClick(info){
      const d=info.dateStr;
      if(!DATA.streams[d]) return;
      alert("Detalles del "+d);
    }
  });
  calendar.render();
}

/* =========================
      TOP
   ========================= */
function renderTop(){
  const list=$("#listTop");
  const count={};
  for(const r of DATA.asistencia){
    let u=r[1],t=r[2];
    if(t==="normal"||t==="tarde") count[u]=(count[u]||0)+1;
  }
  const arr=Object.entries(count).sort((a,b)=>b[1]-a[1]);
  list.innerHTML=arr.map(x=>`
    <li><b>${x[0]}</b></li>
    <li>${x[1]}</li>
  `).join("");
}

/* =========================
      MENU MOVIL
   ========================= */
$("#btnMenu").onclick=()=>{
  mobileOpen=!mobileOpen;
  $("#side").style.display=mobileOpen?"block":"none";
};

/* =========================
      NAV CLICK
   ========================= */
$("#nav-cal").onclick = ()=>show("cal");
$("#nav-top").onclick = ()=>show("top");

/* =========================
      INIT
   ========================= */
(async()=>{
  await refreshData();
  renderCalendar();
  setInterval(refreshData,30000);
})();
</script>

</body>
</html>
