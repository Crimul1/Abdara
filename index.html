<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Calendario de Asistencia Abdara12</title>

  <!-- Fuentes legibles -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>

  <style>
    :root{
      --font-title: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-body: 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

      /* Base mate: negro + gris suave */
      --bg-deep:#050509;   /* negro mate */
      --bg-mid:#070711;
      --bg-card:#090a13;
      --border:#262637;

      --text:#f7f7fb;      /* blanco mate */
      --text-dim:#a6a6b6;

      /* Pasteles inspirados en la imagen (lentes / ojos / cabello) */
      --neon-purple:#b18dff;        /* lila suave */
      --neon-pink:#ff9ac6;          /* rosa pastel */
      --neon-soft:#ff7ad0;          /* rosa-lila estilo lente */

      --header-h:72px;
      --sidebar-w:270px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%; overscroll-behavior:none;}
    body{
      font-family:var(--font-body);
      background:radial-gradient(circle at top,#10101a 0,#050509 40%, #020208 100%);
      color:var(--text);
      overflow:hidden;
    }
    *::-webkit-scrollbar{width:0;height:0}

    .title{
      position:relative;
      font-family:var(--font-title);
      font-weight:700;
      letter-spacing:0.06em;
      font-size:clamp(1.7rem, 2.5vw + 1rem, 2.9rem);
      line-height:1.1;
      background:linear-gradient(120deg, var(--neon-purple), var(--neon-pink));
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:
        0 0 16px rgba(177,141,255,.55),
        0 0 24px rgba(255,154,198,.45);
    }

    .title-small{
      font-family:var(--font-title);
      font-weight:600;
      letter-spacing:0.04em;
      font-size:1.4rem;
      color:var(--text);
      text-shadow:0 0 10px rgba(177,141,255,.45);
    }

    #app{
      display:grid;
      grid-template-columns:var(--sidebar-w) 1fr;
      grid-template-rows:var(--header-h) 1fr;
      grid-template-areas:
        "header header"
        "sidebar main";
      height:100vh;
    }

    header{
      grid-area:header;
      display:flex;
      align-items:center;
      gap:14px;
      padding:0 16px;
      background:linear-gradient(90deg,#050509,#121223,#050509);
      border-bottom:1px solid #302f45;
      box-shadow:0 0 18px rgba(0,0,0,.9);
    }
    .hamburger{
      display:none;
      width:38px; height:38px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#070710;
      color:#fff;
      cursor:pointer;
    }
    .header-spacer{flex:1;}

    .mode-toggle-btn{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#080814;
      color:var(--text-dim);
      font-size:.85rem;
      cursor:pointer;
      transition:.2s;
    }
    .mode-toggle-btn:hover{
      border-color:var(--neon-soft);
      color:#fff;
      box-shadow:0 0 10px rgba(177,141,255,.4);
      background:#0e0e1b;
    }

    /* Modo más mate (menos pastel brillo) */
    body.plain-mode{
      --neon-purple:#a9a3ff;
      --neon-pink:#ffc0dd;
      --neon-soft:#e29bd0;
    }
    body.plain-mode .title{
      text-shadow:0 0 8px rgba(177,141,255,.3);
    }

    aside{
      grid-area:sidebar;
      padding:18px;
      background:radial-gradient(circle at top,#171725 0,#070711 50%,#050509 100%);
      border-right:1px solid #302f45;
      box-shadow:4px 0 18px rgba(0,0,0,.9);
    }
    aside h2{
      font-family:var(--font-title);
      font-weight:600;
      font-size:1.4rem;
      text-align:center;
      color:var(--neon-pink);
      margin-bottom:10px;
      text-shadow:0 0 10px rgba(255,154,198,.55);
    }
    .nav{
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .nav a{
      display:block;
      padding:10px 14px;
      background:#090917;
      border:1px solid var(--border);
      border-radius:12px;
      color:var(--text-dim);
      text-decoration:none;
      transition:.22s;
      cursor:pointer;
      font-size:.95rem;
    }
    .nav a:hover,
    .nav a.active{
      color:#fff;
      border-color:var(--neon-soft);
      background:radial-gradient(circle at 0% 0%,rgba(255,154,198,.18),#0b0b18);
      box-shadow:0 0 18px rgba(255,154,198,.35);
    }

    main{
      grid-area:main;
      position:relative;
      padding:16px;
      height:calc(100vh - var(--header-h));
      overflow:hidden;
      background:
        radial-gradient(1000px 700px at 15% -20%, rgba(255,154,198,.14), transparent 65%),
        radial-gradient(1000px 700px at 110% 10%, rgba(177,141,255,.18), transparent 65%),
        radial-gradient(circle at bottom,#080810 0,#020207 70%);
    }

    .card{
      background:
        radial-gradient(circle at 0 0,rgba(255,154,198,.07), transparent 55%),
        radial-gradient(circle at 100% 0,rgba(177,141,255,.06), transparent 55%),
        #080814;
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:
        0 0 30px rgba(0,0,0,.9),
        inset 0 0 0 1px rgba(255,255,255,0.015);
    }

    #calendarWrap{ height:100%; display:flex; flex-direction:column; }
    #calendar{ flex:1; min-height:0; }

    /* FullCalendar theme */
    .fc{
      --fc-border-color: var(--border);
      font-family:var(--font-body);
    }
    .fc .fc-toolbar-title{
      font-family:var(--font-title);
      font-weight:600;
      color:#ffffff;
      text-shadow:
        0 0 14px rgba(177,141,255,.6),
        0 0 22px rgba(255,154,198,.5);
    }
    .fc .fc-button{
      background:#161527!important;
      border:1px solid #3a3754!important;
      color:#f3f0ff!important;
      transition:.2s;
      border-radius:9px!important;
      font-size:.85rem;
    }
    .fc .fc-button:hover{
      background:var(--neon-soft)!important;
      box-shadow:0 0 12px rgba(255,154,198,.45);
    }
    .fc .fc-daygrid-day-number{ color:var(--text); }
    .fc .fc-col-header-cell-cushion{ color:var(--text-dim); }
    .fc-theme-standard td,
    .fc-theme-standard th{ border-color:var(--border); }

    /* hoy: marco gris/blanco mate, sin confundirse con días de stream */
    .fc-day-today{
      background:linear-gradient(135deg,rgba(245,245,255,.06),rgba(255,154,198,.04))!important;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.18),
        0 0 14px rgba(0,0,0,.7);
      position:relative;
      z-index:1;
    }

    /* Días con stream (de asistencia histórica) */
    .fc-day-with-stream{
      background:linear-gradient(135deg,
        rgba(255,154,198,.10),
        rgba(177,141,255,.08))!important;
      position:relative;
      transition:.25s;
      z-index:0;
    }
    .fc-day-with-stream::after{
      content:"";
      position:absolute;
      inset:3px;
      border-radius:8px;
      box-shadow:
        inset 0 0 10px rgba(177,141,255,.35),
        0 0 8px rgba(255,154,198,.25);
      pointer-events:none;
    }
    /* Punto indicador de stream (abajo a la derecha) */
    .fc-day-with-stream::before{
      content:"";
      position:absolute;
      width:7px;
      height:7px;
      border-radius:50%;
      background:var(--neon-pink);
      bottom:4px;
      right:4px;
      box-shadow:0 0 6px rgba(255,154,198,.9);
      pointer-events:none;
    }
    .fc-day-with-stream:hover{
      background:linear-gradient(135deg,
        rgba(255,154,198,.16),
        rgba(177,141,255,.14))!important;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.10),
        inset 0 0 18px rgba(177,141,255,.55);
    }

    .btn{
      background:#161527;
      border:1px solid var(--neon-soft);
      color:#fff;
      padding:8px 12px;
      border-radius:11px;
      cursor:pointer;
      transition:.2s;
      font-size:.9rem;
    }
    .btn:hover{
      background:var(--neon-soft);
      box-shadow:0 0 12px rgba(255,154,198,.55);
    }

    .input,
    .select{
      background:#090918;
      border:1px solid var(--border);
      color:#fff;
      padding:8px 12px;
      border-radius:10px;
      outline:none;
      font-size:.9rem;
    }
    .input::placeholder{color:#747486;}
    .input:focus,
    .select:focus{
      border-color:var(--neon-soft);
      box-shadow:0 0 10px rgba(255,154,198,.45);
    }

    .view{ display:none; height:100%; }
    .view.active{ display:block; animation:fade .35s ease; }

    /* Top Asistencias */
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin:8px 0 12px;
    }
    .controls-group{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .list{
      list-style:none;
      display:grid;
      grid-template-columns: 1fr auto;
      row-gap:8px;
      column-gap:12px;
      padding:0;
      max-height:calc(100% - 140px);
      overflow:auto;
      font-size:.95rem;
    }
    .list li{
      padding:10px 0;
      border-bottom:1px dashed var(--border);
    }
    .badge{ font-weight:600; }
    .count{
      color:var(--neon-pink);
      font-weight:700;
      text-align:right;
    }
    .pager{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      margin-top:10px;
      font-size:.9rem;
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background:rgba(3,3,8,.75);
      backdrop-filter: blur(4px);
      z-index:50;
    }
    .modal.open{
      display:grid;
      animation:fade .2s ease;
    }
    .modal .box{
      width:min(720px, 92vw);
      max-height:80vh;
      overflow:auto;
      background:#080814;
      border:1px solid var(--border);
      border-radius:20px;
      padding:18px;
      box-shadow:
        0 0 30px rgba(0,0,0,.9),
        0 0 26px rgba(177,141,255,.55);
    }

    .modalList{
      list-style:none;
      margin:0;
      padding:0;
    }
    .modalList li{
      padding:10px 0;
      border-bottom:1px dashed var(--border);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .mUser{ font-weight:600; }
    .mTipo{ color:var(--neon-pink); font-weight:700; }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      background:#101022;
      border:1px solid var(--border);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 0 14px rgba(177,141,255,.35);
      opacity:0;
      transform:translateY(10px);
      transition:.25s;
      z-index:60;
      font-size:.9rem;
    }
    .toast.show{
      opacity:1;
      transform:none;
    }

    @keyframes fade{ from{opacity:0} to{opacity:1} }

    @media (max-width: 920px){
      :root{ --sidebar-w: 0px; }
      #app{
        grid-template-columns: 1fr;
        grid-template-areas: "header" "main";
      }
      aside{
        position:fixed;
        top:var(--header-h);
        left:0;
        bottom:0;
        width:280px;
        transform:translateX(-100%);
        transition:.25s;
        z-index:40;
      }
      aside.open{
        transform:none;
        box-shadow:12px 0 24px rgba(0,0,0,.4);
      }
      .hamburger{
        display:inline-grid;
        place-items:center;
      }
    }
  </style>
</head>
<body>

  <audio id="sfx" src="https://cdn.freesound.org/previews/656/656770_1648170-lq.mp3"></audio>

  <div id="app">
    <header>
      <button class="hamburger" id="btnMenu">☰</button>
      <h1 class="title" id="pageTitle">Calendario de Asistencia Abdara12</h1>
      <div class="header-spacer"></div>
      <button class="mode-toggle-btn" id="modeToggle" type="button" aria-label="Cambiar tema">Neon</button>
    </header>

    <aside id="sidebar">
      <h2>Menú</h2>
      <ul class="nav">
        <li><a id="nav-cal" class="active">Calendario</a></li>
        <li><a id="nav-top">Top Asistencias</a></li>
      </ul>
    </aside>

    <main>
      <section id="view-cal" class="view active">
        <div id="calendarWrap" class="card" style="height:100%">
          <div id="calendar" aria-label="Calendario"></div>
        </div>
      </section>

      <section id="view-top" class="view" aria-live="polite">
        <div class="card" style="height:100%">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
            <h2 class="title-small">Top Asistencias</h2>
            <div style="display:flex; gap:8px;">
              <button class="btn" id="btn-back">&larr; Volver</button>
            </div>
          </div>

          <div class="controls">
            <input id="search" class="input" placeholder="Buscar usuario (/ para enfocar)" />

            <div class="controls-group">
              <select id="type" class="select">
                <option value="all">Tipo: Todos</option>
                <option value="normal">Solo Normal</option>
                <option value="tarde">Solo Tarde</option>
                <option value="extra">Solo Extra</option>
              </select>

              <select id="yearFilter" class="select">
                <option value="">Año: Todos</option>
              </select>

              <select id="monthFilter" class="select">
                <option value="">Mes: Todos</option>
                <option value="1">Enero</option>
                <option value="2">Febrero</option>
                <option value="3">Marzo</option>
                <option value="4">Abril</option>
                <option value="5">Mayo</option>
                <option value="6">Junio</option>
                <option value="7">Julio</option>
                <option value="8">Agosto</option>
                <option value="9">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
              </select>

              <select id="sort" class="select">
                <option value="DESC">Orden: Mayor → Menor</option>
                <option value="ASC">Orden: Menor → Mayor</option>
                <option value="AZ">Nombre A → Z</option>
                <option value="ZA">Nombre Z → A</option>
              </select>

              <select id="pageSize" class="select">
                <option value="10">10 por página</option>
                <option value="15" selected>15 por página</option>
                <option value="25">25 por página</option>
                <option value="50">50 por página</option>
              </select>
            </div>

            <button id="btnReset" class="btn">Reiniciar filtros</button>
          </div>

          <ul id="list" class="list"></ul>

          <div class="pager">
            <span id="pageInfo" style="color:var(--text-dim)"></span>
            <button class="btn" id="prev">Anterior</button>
            <button class="btn" id="next">Siguiente</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="modal" id="modal">
    <div class="box">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;">
        <h3 class="title-small" id="modalTitle">Detalles</h3>
        <button class="btn" id="modalClose">Cerrar</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ===================== CONFIG ===================== */
const API_URL = "https://script.google.com/macros/s/AKfycbysq-navVJ52ZYo1z5T3gBClLlRNhN07HMo84-dUwtH1-0SEgPF-ph6djJaupGR7bul/exec?webAction=get_all_data";
const ZONE = "America/Guatemala";

    let STREAMS = {};
    let ASIST   = [];
    let ASIST_NORM = [];
    let DAYS_WITH_ASIST = new Set(); // <-- días que sí tuvieron asistencia (para colorear calendario)

    const state = {
      query:"",
      type:"all",
      year:null,
      month:null,
      sort:"DESC",
      page:1,
      pageSize:15,
      rows:[]
    };

    /* ===================== HELPERS ===================== */
    const $  = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const debounce = (fn,ms)=>{
      let t;
      return (...a)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...a),ms);
      };
    };

    const playSFX=()=>{
      const s=$('#sfx');
      try{
        s.volume=0.35;
        s.currentTime=0;
        s.play();
      }catch(e){}
    };

    const showToast=(m)=>{
      const el=$('#toast');
      el.textContent=m;
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'),1400);
    };

    const openModal=(t,h)=>{
      $('#modalTitle').textContent=t;
      $('#modalBody').innerHTML=h;
      $('#modal').classList.add('open');
    };
    const closeModal=()=>$('#modal').classList.remove('open');

    const toggleSidebar=(force)=>{
      const sb=$('#sidebar');
      if(force===true) sb.classList.add('open');
      else if(force===false) sb.classList.remove('open');
      else sb.classList.toggle('open');
    };

    /* ===================== NAV ===================== */
    const viewCal=$('#view-cal');
    const viewTop=$('#view-top');

    $('#btnMenu').addEventListener('click', ()=>toggleSidebar());

    $('#nav-cal').addEventListener('click', ()=>{
      show('cal');
      $('#nav-cal').classList.add('active');
      $('#nav-top').classList.remove('active');
      toggleSidebar(false);
    });

    $('#nav-top').addEventListener('click', ()=>{
      buildTop();
      show('top');
      playSFX();
      $('#nav-top').classList.add('active');
      $('#nav-cal').classList.remove('active');
      toggleSidebar(false);
    });

    $('#btn-back').addEventListener('click', ()=>show('cal'));

    function show(v){
      viewCal.classList.toggle('active', v==='cal');
      viewTop.classList.toggle('active', v==='top');
    }

    /* ===================== DATA ===================== */
    async function loadData(){
      try {
        const res = await fetch(API_URL + "&_=" + Date.now());
        if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);

        const json = await res.json();

        STREAMS = json.streams || {};

        ASIST = (json.asistencia || []).filter(r=>{
          const fecha=r[0], user=r[1], tipo=r[2];
          if(!user || !String(user).trim()) return false;
          if(!['normal','tarde','extra'].includes(tipo)) return false;
          if(!fecha || isNaN(Date.parse(fecha))) return false;
          return true;
        });

        precomputeNormalizedData();
      } catch (error) {
        console.error("Error al cargar datos:", error);
        showToast("Error al conectar con la API.");
        throw error;
      }
    }

    /* ===================== CALENDARIO ===================== */
    let calendar;

    function markCellIfStream(cell){
      const d = cell.getAttribute('data-date'); // YYYY-MM-DD de FullCalendar
      if(d && DAYS_WITH_ASIST.has(d)){
        cell.classList.add('fc-day-with-stream');
      }
    }

    function initCalendar(){
      const el = $('#calendar');
      if(calendar){
        try{ calendar.destroy(); }catch(e){}
      }

      calendar = new FullCalendar.Calendar(el,{
        height:'100%',
        expandRows:true,
        initialView:'dayGridMonth',
        locale:'es',
        timeZone: ZONE,
        headerToolbar:{
          left:'prev,next today',
          center:'title',
          right:'dayGridMonth,timeGridWeek'
        },
        dayCellDidMount(info){
          // ahora usamos los días que tienen asistencia (todas las fechas históricas)
          markCellIfStream(info.el);
        },
        dateClick(info){
          const d = info.dayEl.getAttribute('data-date') || info.dateStr;
          const list = ASIST_NORM.filter(a => a.dateISO === d);

          const html = list.length
            ? `<ul class="modalList">
                ${list.map(a=>`
                  <li>
                    <span class="mUser">${a.user}</span>
                    <span class="mTipo">(${a.tipo})</span>
                  </li>
                `).join("")}
              </ul>`
            : '<p>Sin registros.</p>';

          openModal(`Asistencias - ${d}`, html);
          playSFX();
        }
      });

      calendar.render();
    }

    function recolorCalendarDays(){
      // quitar marcas
      $$('.fc-daygrid-day').forEach(c=>c.classList.remove('fc-day-with-stream'));
      // volver a marcar según DAYS_WITH_ASIST
      $$('.fc-daygrid-day').forEach(cell=>{
        markCellIfStream(cell);
      });
    }

    /* ===================== TOP ASISTENCIAS ===================== */
    const $search=$('#search'),
          $type=$('#type'),
          $sort=$('#sort'),
          $year=$('#yearFilter'),
          $month=$('#monthFilter'),
          $pageSize=$('#pageSize'),
          $list=$('#list'),
          $pageInfo=$('#pageInfo'),
          $prev=$('#prev'),
          $next=$('#next'),
          $btnReset=$('#btnReset');

    $search.addEventListener('input', debounce(()=>{
      state.query=($search.value||'').trim().toLowerCase();
      state.page=1;
      renderTop();
    }, 140));

    $type.addEventListener('change', ()=>{
      state.type=$type.value;
      state.page=1;
      buildTop();
      showToast('Filtro de tipo aplicado');
    });

    $year.addEventListener('change', ()=>{
      state.year = $year.value ? parseInt($year.value,10) : null;
      state.page=1;
      buildTop();
      showToast('Filtro de año aplicado');
    });

    $month.addEventListener('change', ()=>{
      state.month = $month.value ? parseInt($month.value,10) : null;
      state.page=1;
      buildTop();
      showToast('Filtro de mes aplicado');
    });

    $sort.addEventListener('change', ()=>{
      state.sort=$sort.value;
      state.page=1;
      renderTop();
    });

    $pageSize.addEventListener('change', ()=>{
      state.pageSize=parseInt($pageSize.value,10);
      state.page=1;
      renderTop();
    });

    $prev.addEventListener('click', ()=>{
      if(state.page>1){
        state.page--;
        renderTop();
      }
    });

    $next.addEventListener('click', ()=>{
      const max=Math.ceil(state.rows.length/state.pageSize)||1;
      if(state.page<max){
        state.page++;
        renderTop();
      }
    });

    $btnReset.addEventListener('click', ()=>{
      $search.value='';
      state.query='';
      $type.value='all';   state.type='all';
      $year.value='';      state.year=null;
      $month.value='';     state.month=null;
      $sort.value='DESC';  state.sort='DESC';
      state.page=1;
      buildTop();
      showToast('Filtros reiniciados');
    });

    function precomputeNormalizedData(){
      ASIST_NORM = [];
      DAYS_WITH_ASIST = new Set();

      ASIST.forEach(r=>{
        const iso = new Date(r[0]).toLocaleDateString('en-CA',{ timeZone: ZONE }); // YYYY-MM-DD
        const [y,m] = iso.split('-').map(n=>parseInt(n,10));
        ASIST_NORM.push({
          raw:r,
          dateISO:iso,
          year:y,
          month:m,
          user:r[1],
          tipo:r[2]
        });
        DAYS_WITH_ASIST.add(iso);
      });

      // llenar combo de años
      const years = new Set();
      ASIST_NORM.forEach(r=>years.add(r.year));
      const sortedYears = Array.from(years).sort((a,b)=>b-a);
      let html = '<option value="">Año: Todos</option>';
      sortedYears.forEach(y=>{ html += `<option value="${y}">${y}</option>`; });
      $year.innerHTML = html;
    }

    function buildTop(){
      const counts = new Map();

      ASIST_NORM.forEach(rec=>{
        if(state.type!=='all' && rec.tipo!==state.type) return;
        if(state.year && rec.year!==state.year) return;
        if(state.month && rec.month!==state.month) return;

        const prev = counts.get(rec.user) || 0;
        counts.set(rec.user, prev+1);
      });

      state.rows = Array.from(counts.entries()).map(([user,count])=>({user,count}));
      renderTop();
    }

    function renderTop(){
      let rows = state.rows.slice();

      if(state.query){
        rows = rows.filter(r => r.user.toLowerCase().includes(state.query));
      }

      if(state.sort==='DESC') rows.sort((a,b)=> b.count - a.count);
      if(state.sort==='ASC') rows.sort((a,b)=> a.count - b.count);
      if(state.sort==='AZ')  rows.sort((a,b)=> a.user.localeCompare(b.user));
      if(state.sort==='ZA')  rows.sort((a,b)=> b.user.localeCompare(a.user));

      const total = rows.length;
      const maxPage = Math.max(1, Math.ceil(total / state.pageSize));
      if(state.page > maxPage) state.page = maxPage;

      const start = (state.page-1)*state.pageSize;
      const end   = start + state.pageSize;
      const pageRows = rows.slice(start,end);

      $list.innerHTML = '';
      const frag = document.createDocumentFragment();

      for(const r of pageRows){
        const liName  = document.createElement('li');
        liName.innerHTML  = `<span class="badge">${r.user}</span>`;
        const liCount = document.createElement('li');
        liCount.innerHTML = `<span class="count">${r.count}</span>`;
        frag.appendChild(liName);
        frag.appendChild(liCount);
      }

      $list.appendChild(frag);

      const maxPageText = maxPage || 1;
      $pageInfo.textContent = `Página ${state.page} / ${maxPageText} — ${total} usuario${total===1?'':'s'}`;
      $list.scrollTo({top:0, behavior:'smooth'});
    }

    /* ===================== MODO NEON / MATE ===================== */
    const modeToggleBtn = $('#modeToggle');
    let neonMode = true;

    modeToggleBtn.addEventListener('click', ()=>{
      neonMode = !neonMode;
      document.body.classList.toggle('plain-mode', !neonMode);
      modeToggleBtn.textContent = neonMode ? 'Neon' : 'Mate';
    });

    /* ===================== STARTUP ===================== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      try {
        await loadData();
        initCalendar();
        buildTop();
      } catch (error) {
        console.error("Error fatal en el inicio:", error);
        $('#calendarWrap').innerHTML = `
          <h2 style="color:var(--neon-pink); margin-bottom:6px;">Error al cargar</h2>
          <p>No se pudo conectar con la base de datos. Revisa que la URL de Google Script sea correcta o inténtalo de nuevo.</p>
        `;
      }

      document.addEventListener('keydown', (e)=>{ 
        if(e.key==='Escape') closeModal(); 
        if(e.key==='/'){
          e.preventDefault();
          $search.focus();
        }
      });

      // Auto-refresh cada 30s
      setInterval(async ()=>{
        try {
          await loadData();
          recolorCalendarDays();
          if(viewTop.classList.contains('active')) buildTop();
        } catch (e) {
          console.warn("Fallo el auto-refresh", e);
          showToast("Error al refrescar datos.");
        }
      }, 30000);
    });

    $('#modalClose').addEventListener('click', closeModal);
    $('#modal').addEventListener('click', (e)=>{ 
      if(e.target.id==='modal') closeModal(); 
    });
  </script>
</body>
</html>
