<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia de Abdara</title>
    
    <!-- 1. Importamos la fuente Gótica de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Unifrakturka+Cook:wght@700&display=swap" rel="stylesheet">

    <!-- 2. Librería de FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>

    <style>
        /* --- 1. Tema Oscuro (NUEVO) --- */
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #121212; /* Fondo negro/gris oscuro */
            color: #e0e0e0; /* Texto claro */
            height: 100%;
        }

        /* --- Layout principal (Sin cambios) --- */
        #app-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            grid-template-rows: 60px 1fr;
            grid-template-areas:
                "header header"
                "sidebar main";
            height: 100vh;
        }

        /* --- 2. Header (NUEVO ESTILO) --- */
        #app-header {
            grid-area: header;
            background-color: #1f1f1f; /* Fondo de header (un poco más claro) */
            color: #ffffff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #333; /* Borde oscuro */
        }
        
        #app-header h1 {
            margin: 0;
            /* Aplicamos la fuente Gótica */
            font-family: 'Unifrakturka Cook', cursive;
            font-size: 2em; /* Más grande */
            
            /* ---- El truco del Gradiente ---- */
            background-image: linear-gradient(to right, #9f50ff, #e13fff);
            -webkit-background-clip: text; /* Para Chrome/Safari */
            background-clip: text;
            color: transparent;
            /* ---------------------------------- */
        }
        
        #logo-placeholder {
            width: 40px;
            height: 40px;
            background-color: #9f50ff; /* Morado del gradiente */
            border-radius: 50%;
            margin-right: 15px;
            /* background-image: url('URL_DE_TU_LOGO.png'); */
        }

        /* --- 3. Sidebar (NUEVO ESTILO) --- */
        #app-sidebar {
            grid-area: sidebar;
            background-color: #1f1f1f; /* Igual que el header */
            color: #e0e0e0;
            padding: 20px;
            border-right: 1px solid #333; /* Borde oscuro */
        }
        #app-sidebar h2 {
            margin-top: 0;
            color: white;
            font-family: 'Unifrakturka Cook', cursive; /* Fuente gótica aquí también */
            font-size: 1.8em;
            text-align: center;
            border-bottom: 1px solid #4a0072; /* Morado oscuro */
            padding-bottom: 10px;
        }
        #app-sidebar ul { list-style: none; padding: 0; }
        #app-sidebar li a {
            display: block;
            padding: 12px 15px;
            text-decoration: none;
            color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 1.1em;
            cursor: pointer;
        }
        #app-sidebar li a:hover {
            background-color: #4a0072; /* Morado oscuro al pasar el mouse */
            color: white;
        }

        /* --- 4. Contenido Principal (NUEVO ESTILO) --- */
        #app-content {
            grid-area: main;
            padding: 30px;
            overflow-y: auto;
        }
        
        .vista-contenido {
            background: #242424; /* Fondo de contenido (más claro que el body) */
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        /* --- 5. Forzar FullCalendar a Dark Mode (NUEVO) --- */
        /* Color del título (ej: "noviembre 2025") */
        .fc .fc-toolbar-title {
            color: white;
        }
        /* Color de los números del día */
        .fc .fc-daygrid-day-number {
            color: #e0e0e0;
        }
        /* Color de los nombres de la semana (lun, mar, mie...) */
        .fc .fc-col-header-cell-cushion {
            color: white;
        }
        /* Botones (today, prev, next) */
        .fc .fc-button {
            background-color: #4a0072;
            border-color: #4a0072;
        }
        .fc .fc-button:hover {
            background-color: #7b1fa2;
        }

        /*
         * ¡AQUÍ ESTÁ TU CAMBIO!
         * Esto pinta el fondo del DÍA (la celda entera)
         * de un color morado oscuro si hubo stream.
         */
        .fc-day-with-stream {
            background-color: #3a0061 !important; /* Morado oscuro (un poco claro) */
            cursor: pointer;
        }
        .fc-day-with-stream:hover {
            background-color: #4a0072 !important; /* Más claro al pasar el mouse */
        }

        /* --- Estilos de la vista de Detalles (Dark Mode) --- */
        #vista-detalles h2 { margin-top: 0; color: white; }
        #btn-volver {
            background: #6c757d; color: white; border: none;
            padding: 10px 15px; border-radius: 5px; cursor: pointer;
            font-size: 1em; margin-bottom: 20px;
        }
        #btn-volver:hover { background: #5a6268; }
        #detalles-lista { list-style-type: none; padding: 0; }
        #detalles-lista li {
            padding: 10px;
            border-bottom: 1px solid #333; /* Borde oscuro */
            font-size: 1.1em;
        }
        #detalles-lista li:last-child { border-bottom: none; }
        /* Colores de asistencia */
        #detalles-lista .tipo-normal { color: #28a745; }
        #detalles-lista .tipo-tarde { color: #ffc107; }
        #detalles-lista .tipo-extra { color: #007bff; }
    </style>
</head>
<body>

    <!-- Esta es la nueva estructura profesional -->
    <div id="app-container">
        
        <!-- 1. HEADER -->
        <header id="app-header">
            <div id="logo-placeholder"></div>
            <h1>Calendario de Asistencia Abdara 12</h1>
        </header>

        <!-- 2. SIDEBAR -->
        <aside id="app-sidebar">
            <h2>Navegación</h2>
            <ul>
                <li><a id="link-calendario">Calendario</a></li>
                <li><a id="link-top3">Top 3 Asistencias</a></li>
            </ul>
        </aside>

        <!-- 3. MAIN CONTENT -->
        <main id="app-content">

            <!-- "Vista" 1: El Calendario (se muestra por defecto) -->
            <div id="vista-calendario" class="vista-contenido">
                <!-- El calendario se dibujará aquí -->
            </div>

            <!-- "Vista" 2: Detalles del Día (oculta por defecto) -->
            <div id="vista-detalles" class="vista-contenido" style="display: none;">
                <button id="btn-volver">&larr; Volver al Calendario</button>
                <h2 id="detalles-titulo"></h2>
                <ul id="detalles-lista"></ul>
            </div>

            <!-- "Vista" 3: Top 3 (oculta por defecto) -->
            <div id="vista-top3" class="vista-contenido" style="display: none;">
                <button id="btn-volver-top3">&larr; Volver al Calendario</button>
                <h2>Top 3 Asistencias</h2>
                <ul id="listaTop3"></ul>
            </div>

        </main>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const API_URL = "https://script.google.com/macros/s/AKfycbx6WjqODhuetXMwsAtzfvXY539Quj1exnRz7s7J6FQBH2UAlag6Brs6InxPsRS3uq2F/exec?webAction=get_all_data";
        const TIME_ZONE = "America/Guatemala"; // GTM-6

        // --- LÓGICA DE LA APP ---

        function mostrarVista(vistaId) {
            document.getElementById('vista-calendario').style.display = 'none';
            document.getElementById('vista-detalles').style.display = 'none';
            document.getElementById('vista-top3').style.display = 'none';
            
            document.getElementById(vistaId).style.display = 'block';
        }

        document.addEventListener("DOMContentLoaded", () => {
            cargarDatos();

            document.getElementById('link-calendario').addEventListener('click', () => mostrarVista('vista-calendario'));
            
            document.getElementById('link-top3').addEventListener('click', () => {
                prepararBotonTop3(window.datosAsistencia); 
                mostrarVista('vista-top3'); 
            });

            document.getElementById('btn-volver').addEventListener('click', () => mostrarVista('vista-calendario'));
            document.getElementById('btn-volver-top3').addEventListener('click', () => mostrarVista('vista-calendario'));
        });

        async function cargarDatos() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                console.log("Datos recibidos:", data);
                
                window.datosAsistencia = data.asistencia; 
                window.datosStreams = data.streams;

                renderizarCalendario(data.streams, data.asistencia);

            } catch (error) {
                console.error("Error al cargar los datos:", error);
                document.getElementById("vista-calendario").innerHTML = "<p>Error al cargar los datos.</p>";
            }
        }

        // --- FUNCIÓN DEL CALENDARIO (¡ACTUALIZADA!) ---
        function renderizarCalendario(streams, asistencias) {
            const calendarioEl = document.getElementById('vista-calendario');
            
            // ¡YA NO CREAMOS EL ARRAY DE "eventos"!
            // Con esto eliminamos la barra azul "Stream".

            const calendar = new FullCalendar.Calendar(calendarioEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                timeZone: TIME_ZONE,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                
                // events: eventos, // <-- LÍNEA ELIMINADA

                // Esto pinta el fondo del DÍA (lo que querías)
                dayCellDidMount: function(arg) {
                    const fechaSimple = arg.date.toISOString().split('T')[0];
                    if (streams[fechaSimple]) {
                        arg.el.classList.add('fc-day-with-stream');
                    }
                },
                
                // Al hacer clic en un día
                dateClick: function(info) {
                    const fechaSimpleClick = info.dateStr;

                    // Si el día no tuvo stream (revisando 'streams'), no hacer nada
                    if (!streams[fechaSimpleClick]) {
                        return;
                    }
                    
                    // Buscar asistencias de ESE día
                    const asistenciasDelDia = asistencias.filter(a => {
                        const fechaAsistencia = new Date(a[0]).toLocaleDateString('en-CA', { timeZone: TIME_ZONE });
                        return fechaAsistencia === fechaSimpleClick;
                    });
                    
                    // Llenar la nueva vista
                    document.getElementById('detalles-titulo').innerText = `Asistencias del ${fechaSimpleClick}`;
                    const listaEl = document.getElementById('detalles-lista');
                    listaEl.innerHTML = ""; 

                    if (asistenciasDelDia.length > 0) {
                        asistenciasDelDia.forEach(a => {
                            const usuario = a[1];
                            const tipo = a[2]; 
                            const li = document.createElement("li");
                            li.innerHTML = `${usuario} <span class="tipo-${tipo}">(${tipo})</span>`;
                            listaEl.appendChild(li);
                        });
                    } else {
                        listaEl.innerHTML = "<li>No se registraron asistencias.</li>";
                    }
                    
                    // Mostrar la vista de detalles
                    mostrarVista('vista-detalles');
                }
            });

            calendar.render();
        }

        // --- FUNCIÓN DEL TOP 3 ---
        function prepararBotonTop3(asistencias) {
            const conteo = {};
            
            if (!asistencias) {
                document.getElementById("listaTop3").innerHTML = "<li>Datos no cargados.</li>";
                return;
            }

            asistencias.forEach(registro => {
                const usuario = registro[1];
                const tipo = registro[2];
                
                if (tipo === "normal" || tipo === "tarde") {
                    conteo[usuario] = (conteo[usuario] || 0) + 1;
                }
            });
            
            const arrayConteo = Object.entries(conteo);
            arrayConteo.sort((a, b) => b[1] - a[1]);
            const top3 = arrayConteo.slice(0, 3);
            
            const listaEl = document.getElementById("listaTop3");
            listaEl.innerHTML = ""; 
            
            if (top3.length === 0) {
                 listaEl.innerHTML = "<li>Aún no hay asistencias para mostrar.</li>";
                 return;
            }

            top3.forEach(item => {
                const li = document.createElement("li");
                li.textContent = `${item[0]} (${item[1]} asistencias)`;
                listaEl.appendChild(li);
            });
        }

    </script>
</body>
</html>
