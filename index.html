<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Calendario de Asistencia Abdara12</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>

  <style>
    :root{
      --font-title: 'UnifrakturCook', cursive;
      --font-body: 'Roboto', sans-serif;

      /* Dark Neon */
      --bg-deep:#080808;
      --bg-mid:#101010;
      --bg-card:#151515;
      --border:#262626;

      --text:#ededed;
      --text-dim:#a9a9a9;

      --neon-purple:#8d3aff;
      --neon-pink:#ff38c7;
      --neon-dark:#3a0061;

      --header-h:72px;
      --sidebar-w:270px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%; overscroll-behavior:none;}
    body{font-family:var(--font-body);background:var(--bg-deep);color:var(--text);overflow:hidden}
    *::-webkit-scrollbar{width:0;height:0}

    .title{
      position:relative;
      font-family:var(--font-title);
      font-size:clamp(1.6rem, 2.4vw + 1rem, 2.8rem);
      line-height:1;
      color:#dcd0ff;
      background:linear-gradient(90deg, var(--neon-purple), var(--neon-pink));
      -webkit-background-clip:text; background-clip:text;
      -webkit-text-fill-color:transparent;
      filter:drop-shadow(0 0 6px rgba(141,58,255,.6)) drop-shadow(0 0 14px rgba(255,56,199,.35));
    }
    .title::after{
      content:attr(data-text);
      position:absolute; inset:0;
      -webkit-text-fill-color:transparent;
      text-shadow:0 0 1px rgba(255,255,255,.35), 0 0 2px rgba(141,58,255,.45);
      pointer-events:none;
    }

    #app{
      display:grid;
      grid-template-columns:var(--sidebar-w) 1fr;
      grid-template-rows:var(--header-h) 1fr;
      grid-template-areas:
        "header header"
        "sidebar main";
      height:100vh;
    }

    header{
      grid-area:header;
      display:flex; align-items:center; gap:14px;
      padding:0 16px;
      background:var(--bg-mid);
      border-bottom:1px solid var(--border);
    }
    .hamburger{
      display:none; width:38px; height:38px; border-radius:8px;
      border:1px solid var(--border);
      background:#131313; color:#fff; cursor:pointer;
    }

    aside{
      grid-area:sidebar;
      padding:18px;
      background:var(--bg-mid);
      border-right:1px solid var(--border);
    }
    aside h2{
      font-family:var(--font-title); font-size:1.6rem; text-align:center;
      color:var(--neon-purple); text-shadow:0 0 10px var(--neon-purple); margin-bottom:10px;
    }
    .nav{ list-style:none; display:flex; flex-direction:column; gap:10px; }
    .nav a{
      display:block; padding:10px 14px; background:#131313;
      border:1px solid var(--border); border-radius:10px; color:var(--text-dim);
      text-decoration:none; transition:.25s; cursor:pointer;
    }
    .nav a:hover, .nav a.active{ color:#fff; background:var(--neon-dark); box-shadow:0 0 14px var(--neon-purple); }

    main{
      grid-area:main; position:relative;
      padding:16px; height:calc(100vh - var(--header-h)); overflow:hidden;
      background:
        radial-gradient(1200px 800px at 20% -20%, rgba(141,58,255,.12), transparent 60%),
        radial-gradient(1200px 800px at 120% 20%, rgba(255,56,199,.12), transparent 60%);
    }

    .card{
      background:var(--bg-card); border:1px solid var(--border);
      border-radius:14px; padding:16px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02), 0 0 24px rgba(141,58,255,.08);
    }

    #calendarWrap{ height:100%; display:flex; flex-direction:column; }
    #calendar{ flex:1; min-height:0; }

    /* FullCalendar theme */
    .fc{ --fc-border-color: var(--border); }
    .fc .fc-toolbar-title{ font-family:var(--font-title); color:#fff; text-shadow:0 0 12px var(--neon-purple); }
    .fc .fc-button{ background:var(--neon-dark)!important; border:none!important; color:#fff!important; transition:.25s; }
    .fc .fc-button:hover{ background:var(--neon-purple)!important; box-shadow:0 0 12px var(--neon-purple); }
    .fc .fc-daygrid-day-number{ color:var(--text); }
    .fc .fc-col-header-cell-cushion{ color:var(--text-dim); }
    .fc-theme-standard td, .fc-theme-standard th{ border-color:var(--border); }
    .fc-day-today{ background:#1a1220!important; }

    .fc-day-with-stream{ background:#2a0047!important; transition:.25s; }
    .fc-day-with-stream:hover{ background:#43007a!important; box-shadow:inset 0 0 12px var(--neon-purple); }

    .btn{ background:var(--neon-dark); border:1px solid var(--neon-purple); color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; transition:.25s; }
    .btn:hover{ background:var(--neon-purple); box-shadow:0 0 12px var(--neon-purple); }
    .input, .select{ background:#131313; border:1px solid var(--border); color:#fff; padding:8px 12px; border-radius:10px; outline:none; }
    .input:focus, .select:focus{ border-color:var(--neon-purple); box-shadow:0 0 10px var(--neon-purple); }

    .view{ display:none; height:100%; }
    .view.active{ display:block; animation:fade .35s ease; }

    /* Top Asistencias */
    .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:8px 0 12px; }
    .list{ list-style:none; display:grid; grid-template-columns: 1fr auto; row-gap:8px; column-gap:12px; padding:0; max-height:calc(100% - 140px); overflow:auto; }
    .list li{ padding:10px 0; border-bottom:1px dashed var(--border); }
    .badge{ font-weight:700; }
    .count{ color:var(--neon-pink); }
    .pager{ display:flex; align-items:center; gap:10px; justify-content:flex-end; margin-top:10px; }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); backdrop-filter: blur(3px); z-index:50; }
    .modal.open{ display:grid; animation:fade .2s ease; }
    .modal .box{ width:min(720px, 92vw); max-height:80vh; overflow:auto; background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 0 24px rgba(141,58,255,.25); }

    .toast{ position:fixed; right:16px; bottom:16px; background:#141414; border:1px solid var(--border); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 0 14px rgba(141,58,255,.25); opacity:0; transform:translateY(10px); transition:.25s; z-index:60; }
    .toast.show{ opacity:1; transform:none; }

    @keyframes fade{ from{opacity:0} to{opacity:1} }

    @media (max-width: 920px){
      :root{ --sidebar-w: 0px; }
      #app{ grid-template-columns: 1fr; grid-template-areas: "header" "main"; }
      aside{ position:fixed; top:var(--header-h); left:0; bottom:0; width:280px; transform:translateX(-100%); transition:.25s; z-index:40; }
      aside.open{ transform:none; box-shadow:12px 0 24px rgba(0,0,0,.4); }
      .hamburger{ display:inline-grid; place-items:center; }
    }
  </style>
</head>
<body>

  <audio id="sfx" src="https://cdn.freesound.org/previews/656/656770_1648170-lq.mp3"></audio>

  <div id="app">
    <header>
      <button class="hamburger" id="btnMenu">☰</button>
      <h1 class="title" id="pageTitle" data-text="Calendario de Asistencia Abdara12">Calendario de Asistencia Abdara12</h1>
    </header>

    <aside id="sidebar">
      <h2>Menú</h2>
      <ul class="nav">
        <li><a id="nav-cal" class="active">Calendario</a></li>
        <li><a id="nav-top">Top Asistencias</a></li>
      </ul>
    </aside>

    <main>
      <section id="view-cal" class="view active">
        <div id="calendarWrap" class="card" style="height:100%">
          <div id="calendar" aria-label="Calendario"></div>
        </div>
      </section>

      <section id="view-top" class="view" aria-live="polite">
        <div class="card" style="height:100%">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
            <h2 class="title" data-text="Top Asistencias">Top Asistencias</h2>
            <div style="display:flex; gap:8px;">
              <button class="btn" id="btn-back">&larr; Volver</button>
            </div>
          </div>

          <div class="controls">
            <input id="search" class="input" placeholder="Buscar usuario (/ para enfocar)" />
            <select id="type" class="select">
              <option value="all">Todos los tipos</option>
              <option value="normal">Solo Normal</option>
              <option value="tarde">Solo Tarde</option>
              <option value="extra">Solo Extra</option>
            </select>
            <select id="sort" class="select">
              <option value="DESC">Mayor → Menor</option>
              <option value="ASC">Menor → Mayor</option>
              <option value="AZ">Nombre A → Z</option>
              <option value="ZA">Nombre Z → A</option>
            </select>
            <select id="pageSize" class="select">
              <option value="10">10 por página</option>
              <option value="15" selected>15 por página</option>
              <option value="25">25 por página</option>
              <option value="50">50 por página</option>
            </select>
            <button id="btnReset" class="btn">Reiniciar</button>
          </div>

          <ul id="list" class="list"></ul>

          <div class="pager">
            <span id="pageInfo" style="color:var(--text-dim)"></span>
            <button class="btn" id="prev">Anterior</button>
            <button class="btn" id="next">Siguiente</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="modal" id="modal">
    <div class="box">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;">
        <h3 class="title" id="modalTitle" data-text="Detalles">Detalles</h3>
        <button class="btn" id="modalClose">Cerrar</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ===================== CONFIG ===================== */
    // ¡URL ACTUALIZADA!
    const API_URL = "https://script.google.com/macros/s/AKfycbyuKcRSYLocxg4ngwnw3a0dRlU51vrwOIs6DN74hGweWAr82IB5sTExzoiRloF4Hk4x/exec";
    const ZONE = "America/Guatemala";

    let STREAMS = {};
    let ASIST = [];

    const memoCounts = new Map(); // type -> Map(user=>count)

    const state = { query:"", type:"all", sort:"DESC", page:1, pageSize:15, rows:[] };

    /* ===================== HELPERS ===================== */
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } };
    const playSFX=()=>{ const s=$('#sfx'); try{ s.volume=0.35; s.currentTime=0; s.play(); }catch(e){} };
    const showToast=(m)=>{ const el=$('#toast'); el.textContent=m; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1400); };
    const openModal=(t,h)=>{ $('#modalTitle').textContent=t; $('#modalBody').innerHTML=h; $('#modal').classList.add('open'); };
    const closeModal=()=>$('#modal').classList.remove('open');
    const toggleSidebar=(force)=>{ const sb=$('#sidebar'); if(force===true) sb.classList.add('open'); else if(force===false) sb.classList.remove('open'); else sb.classList.toggle('open'); };

    /* ===================== NAV ===================== */
    const viewCal=$('#view-cal'); const viewTop=$('#view-top');
    $('#btnMenu').addEventListener('click', ()=>toggleSidebar());
    $('#nav-cal').addEventListener('click', ()=>{ show('cal'); $('#nav-cal').classList.add('active'); $('#nav-top').classList.remove('active'); toggleSidebar(false); });
    $('#nav-top').addEventListener('click', ()=>{ buildTop(); show('top'); playSFX(); $('#nav-top').classList.add('active'); $('#nav-cal').classList.remove('active'); toggleSidebar(false); });
    $('#btn-back').addEventListener('click', ()=>show('cal'));
    function show(v){ viewCal.classList.toggle('active', v==='cal'); viewTop.classList.toggle('active', v==='top'); }

    /* ===================== DATA ===================== */
    async function loadData(){
      try {
        const res = await fetch(API_URL + "&_=" + Date.now());
        if (!res.ok) {
          throw new Error(`Error HTTP: ${res.status}`);
        }
        
        const json = await res.json();

        STREAMS = json.streams || {};

        // Anti “1 fantasma”: filtra filas inválidas
        ASIST = (json.asistencia || []).filter(r=>{
          const fecha=r[0], user=r[1], tipo=r[2];
          if(!user || !String(user).trim()) return false;
          if(!['normal','tarde','extra'].includes(tipo)) return false;
          if(!fecha || isNaN(Date.parse(fecha))) return false;
          return true;
        });
      } catch (error) {
        console.error("Error al cargar datos:", error);
        showToast("Error al conectar con la API.");
        throw error; // Lanzar el error para que el inicio (startup) lo detenga
      }
    }

    /* ===================== CALENDARIO ===================== */
    let calendar;
    function initCalendar(){
      const el = $('#calendar');
      if(calendar){ try{ calendar.destroy(); }catch(e){} }
      calendar = new FullCalendar.Calendar(el,{
        height:'100%',
        expandRows:true,
        initialView:'dayGridMonth',
        locale:'es',
        timeZone: ZONE,
        headerToolbar:{ left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek' },
        dayCellDidMount(info){
          const iso = info.date.toISOString().split('T')[0];
          if(STREAMS[iso]) info.el.classList.add('fc-day-with-stream');
        },
        dateClick(info){
          const f = info.dateStr;
          if(!STREAMS[f]) return;
          const list = ASIST.filter(a => new Date(a[0]).toLocaleDateString('en-CA',{timeZone:ZONE}) === f);
          const html = list.length
            ? `<ul style="list-style:none; padding:0; margin:0">
                ${list.map(a=>`<li style="padding:8px 0; border-bottom:1px dashed var(--border)"><b>${a[1]}</b> <span style="color:var(--neon-pink)">(${a[2]})</span></li>`).join('')}
              </ul>`
            : '<p>Sin registros.</p>';
          openModal(`Asistencias — ${f}`, html);
          playSFX();
        }
      });
      calendar.render();
    }

    function recolorCalendarDays(){
      $$('.fc-daygrid-day').forEach(c=>c.classList.remove('fc-day-with-stream'));
      $$('.fc-daygrid-day').forEach(cell=>{
        const d = cell.getAttribute('data-date');
        if(d && STREAMS[d]) cell.classList.add('fc-day-with-stream');
      });
    }

    /* ===================== TOP ASISTENCIAS ===================== */
    const $search=$('#search'), $type=$('#type'), $sort=$('#sort'),
          $pageSize=$('#pageSize'), $list=$('#list'), $pageInfo=$('#pageInfo'),
          $prev=$('#prev'), $next=$('#next'), $btnReset=$('#btnReset');

    $search.addEventListener('input', debounce(()=>{ state.query=($search.value||'').trim().toLowerCase(); state.page=1; renderTop(); }, 140));
    $type.addEventListener('change', ()=>{ state.type=$type.value; state.page=1; buildTop(); showToast('Filtro aplicado'); });
    $sort.addEventListener('change', ()=>{ state.sort=$sort.value; state.page=1; renderTop(); });
    $pageSize.addEventListener('change', ()=>{ state.pageSize=parseInt($pageSize.value,10); state.page=1; renderTop(); });
    $prev.addEventListener('click', ()=>{ if(state.page>1){ state.page--; renderTop(); } });
    $next.addEventListener('click', ()=>{ const max=Math.ceil(state.rows.length/state.pageSize)||1; if(state.page<max){ state.page++; renderTop(); } });
    $btnReset.addEventListener('click', ()=>{ $search.value=''; state.query=''; $type.value='all'; state.type='all'; $sort.value='DESC'; state.sort='DESC'; state.page=1; renderTop(); showToast('Filtros reiniciados'); });

    function precomputeCounts(){
      memoCounts.clear();
      const types=['all','normal','tarde','extra'];
      for(const t of types) memoCounts.set(t,new Map());
      for(const r of ASIST){
        const user=r[1], tipo=r[2];
        memoCounts.get('all').set(user,(memoCounts.get('all').get(user)||0)+1);
        if(memoCounts.has(tipo)) memoCounts.get(tipo).set(user,(memoCounts.get(tipo).get(user)||0)+1);
      }
    }

    function buildTop(){
      const m = memoCounts.get(state.type)||new Map();
      state.rows = Array.from(m.entries()).map(([user,count])=>({user, count}));
      renderTop();
    }

    function renderTop(){
      let rows = state.rows.slice();

      if(state.query) rows = rows.filter(r => r.user.toLowerCase().includes(state.query));

      if(state.sort==='DESC') rows.sort((a,b)=> b.count - a.count);
      if(state.sort==='ASC') rows.sort((a,b)=> a.count - b.count);
      if(state.sort==='AZ')  rows.sort((a,b)=> a.user.localeCompare(b.user));
      if(state.sort==='ZA')  rows.sort((a,b)=> b.user.localeCompare(a.user));

      const total = rows.length;
      const maxPage = Math.max(1, Math.ceil(total / state.pageSize));
      if(state.page > maxPage) state.page = maxPage;

      const start = (state.page-1)*state.pageSize;
      const end = start + state.pageSize;
      const pageRows = rows.slice(start,end);

      $list.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(const r of pageRows){
        const liName=document.createElement('li');  liName.innerHTML = `<span class="badge">${r.user}</span>`;
        const liCount=document.createElement('li'); liCount.innerHTML = `<span class="count">${r.count}</span>`;
        frag.appendChild(liName); frag.appendChild(liCount);
      }
      $list.appendChild(frag);

      $pageInfo.textContent = `Página ${state.page} / ${maxPage} — ${total} usuarios`;
      $list.scrollTo({top:0, behavior:'smooth'});
    }

    /* ===================== STARTUP ===================== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      try {
        await loadData();
        initCalendar();
        precomputeCounts();
      } catch (error) {
        console.error("Error fatal en el inicio:", error);
        $('#calendarWrap').innerHTML = `<h2 style="color:var(--neon-pink)">Error al cargar</h2><p>No se pudo conectar con la base de datos. Revisa que la URL de Google Script sea correcta o inténtalo de nuevo.</p>`;
      }

      // atajos
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); if(e.key==='/'){ e.preventDefault(); $search.focus(); } });

      // auto-refresh cada 30s
      setInterval(async ()=>{
        try {
          await loadData();
          recolorCalendarDays();
          precomputeCounts();
          if(viewTop.classList.contains('active')) buildTop();
        } catch (e) {
          console.warn("Fallo el auto-refresh", e);
          showToast("Error al refrescar datos.");
        }
      }, 30000);
    });

    // Modal close
    $('#modalClose').addEventListener('click', closeModal);
    $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });
  </script>
</body>
</html>
