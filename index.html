<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Calendario de Asistencia Abdara12</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>

  <style>
    :root {
      --font-title: 'UnifrakturCook', cursive;
      --font-body: 'Roboto', sans-serif;

      /* === Tema Dark Mate Profesional === */
      --bg-deep: #121212;
      --bg-mid: #181818;
      --bg-card: #1e1e1e;
      --border: #333;

      --text: #e0e0e0;
      --text-dim: #9e9e9e;

      --accent-primary: #8d3aff;
      --accent-secondary: #d633b0;
      --accent-dark: #2a134d;

      --header-h: 72px;
      --sidebar-w: 270px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overscroll-behavior: none; }

    body {
      font-family: var(--font-body);
      background: radial-gradient(1200px 800px at 50% -20%, rgba(141,58,255,0.08), transparent 70%),
                  radial-gradient(1000px 700px at 80% 120%, rgba(214,51,176,0.07), transparent 60%),
                  var(--bg-deep);
      color: var(--text);
      overflow: hidden;
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

    .title {
      font-family: var(--font-title);
      font-size: clamp(1.5rem, 2vw + 1rem, 2.6rem);
      color: #fff;
      text-shadow: 0 0 12px rgba(141,58,255,0.35);
    }

    #app {
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      grid-template-rows: var(--header-h) 1fr;
      grid-template-areas: "header header" "sidebar main";
      height: 100vh;
    }

    header {
      grid-area: header;
      display: flex; align-items: center; gap: 16px;
      padding: 0 20px;
      background: var(--bg-mid);
      border-bottom: 1px solid var(--border);
    }

    .hamburger {
      display: none; width: 40px; height: 40px; border-radius: 8px;
      background: transparent; color: #fff; border: 1px solid var(--border);
      cursor: pointer; font-size: 1.2rem; transition: .25s;
    }
    .hamburger:hover { background: var(--accent-dark); border-color: var(--accent-primary); }

    aside {
      grid-area: sidebar;
      padding: 20px;
      background: var(--bg-mid);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
    }

    aside h2 {
      font-family: var(--font-title);
      color: var(--accent-primary);
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 12px;
      text-shadow: 0 0 10px rgba(141,58,255,0.5);
    }

    .nav { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .nav a {
      padding: 10px 14px;
      border-radius: 10px;
      color: var(--text-dim);
      text-decoration: none;
      background: transparent;
      transition: .25s;
      cursor: pointer;
    }
    .nav a:hover, .nav a.active {
      background: var(--accent-dark);
      color: #fff;
      box-shadow: 0 0 14px rgba(141,58,255,0.25);
    }

    main {
      grid-area: main;
      position: relative;
      padding: 20px;
      overflow: hidden;
      height: calc(100vh - var(--header-h));
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      height: 100%;
      display: flex; flex-direction: column;
    }

    #calendarWrap { flex: 1; display: flex; flex-direction: column; }
    #calendar { flex: 1; }

    /* === FullCalendar === */
    .fc { font-family: var(--font-body); --fc-border-color: var(--border); }
    .fc .fc-toolbar-title { font-family: var(--font-title); color: #fff; text-shadow: 0 0 12px rgba(141,58,255,0.3); }
    .fc .fc-col-header-cell-cushion { color: var(--text-dim); text-transform: uppercase; font-size: 0.8rem; }
    .fc .fc-daygrid-day-number { color: var(--text); font-weight: 500; }

    .fc .fc-button {
      background: var(--bg-card)!important;
      border: 1px solid var(--border)!important;
      color: var(--text)!important;
      transition: .25s;
    }
    .fc .fc-button:hover {
      background: var(--accent-dark)!important;
      border-color: var(--accent-primary)!important;
      color: #fff!important;
    }

    .fc-day-today { background: rgba(141,58,255,0.1)!important; }
    .fc-day-with-stream { background: rgba(141,58,255,0.18)!important; position: relative; transition: .25s; }
    .fc-day-with-stream::after {
      content: '●'; position: absolute; bottom: 6px; right: 8px; color: var(--accent-primary); font-size: .8rem;
    }
    .fc-day-with-stream:hover { background: rgba(141,58,255,0.25)!important; }

    /* === Botones e Inputs === */
    .btn {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: .25s;
    }
    .btn:hover {
      background: var(--accent-dark);
      border-color: var(--accent-primary);
      color: #fff;
    }

    .input, .select {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      outline: none;
      font-family: inherit;
      transition: .25s;
    }
    .input:focus, .select:focus { border-color: var(--accent-primary); }

    .controls {
      display: flex; flex-wrap: wrap; gap: 10px;
      margin-bottom: 12px; align-items: center;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    .list { list-style: none; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
    .list li {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.03);
      border: 1px solid transparent;
      border-radius: 8px;
      padding: 10px 14px;
      transition: .25s;
    }
    .list li:hover { background: rgba(255,255,255,0.07); border-color: var(--border); }
    .badge { color: #fff; font-weight: 500; }
    .count { color: var(--accent-primary); font-weight: 700; }

    .pager {
      display: flex; justify-content: flex-end; align-items: center; gap: 10px;
      margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);
    }

    /* === Modal === */
    .modal {
      position: fixed; inset: 0; display: none; place-items: center;
      background: rgba(0,0,0,0.65); backdrop-filter: blur(4px);
      z-index: 50;
    }
    .modal.open { display: grid; animation: fade .2s ease; }
    .modal .box {
      width: min(600px, 90vw);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modalList { list-style: none; display: flex; flex-direction: column; gap: 6px; }
    .modalList li { display: flex; justify-content: space-between; padding: 10px; background: var(--bg-deep); border-radius: 6px; }
    .mUser { font-weight: 600; }
    .mTipo { color: var(--accent-secondary); font-weight: 700; }

    .toast {
      position: fixed; bottom: 20px; right: 20px;
      background: var(--bg-card); border: 1px solid var(--accent-primary);
      color: #fff; padding: 12px 16px; border-radius: 8px;
      opacity: 0; transform: translateY(15px); transition: .25s;
    }
    .toast.show { opacity: 1; transform: none; }

    @keyframes fade { from {opacity:0} to {opacity:1} }

    @media (max-width: 920px) {
      :root { --sidebar-w: 0; }
      #app { grid-template-columns: 1fr; grid-template-areas: "header" "main"; }
      aside { position: fixed; top: var(--header-h); bottom: 0; left: 0; width: 270px; transform: translateX(-100%); transition: .25s; }
      aside.open { transform: none; box-shadow: 8px 0 24px rgba(0,0,0,0.5); }
      .hamburger { display: inline-grid; place-items: center; }
    }
  </style>
</head>
<body>

<audio id="sfx" src="https://cdn.freesound.org/previews/656/656770_1648170-lq.mp3"></audio>

<div id="app">
  <header>
    <button class="hamburger" id="btnMenu">☰</button>
    <h1 class="title">Calendario de Asistencia Abdara12</h1>
  </header>

  <aside id="sidebar">
    <h2>Menú</h2>
    <ul class="nav">
      <li><a id="nav-cal" class="active">Calendario</a></li>
      <li><a id="nav-top">Top Asistencias</a></li>
    </ul>
  </aside>

  <main>
    <section id="view-cal" class="view active">
      <div id="calendarWrap" class="card">
        <div id="calendar"></div>
      </div>
    </section>

    <section id="view-top" class="view">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h2 class="title" style="font-size:1.8rem">Top Asistencias</h2>
          <button class="btn" id="btn-back">Volver</button>
        </div>

        <div class="controls">
          <input id="search" class="input" placeholder="Buscar usuario..." />
          <select id="month" class="select">
            <option value="all">Todos los meses</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
          <select id="type" class="select">
            <option value="all">Todos los tipos</option>
            <option value="normal">Normal</option>
            <option value="tarde">Tarde</option>
            <option value="extra">Extra</option>
          </select>
          <select id="sort" class="select">
            <option value="DESC">Mayor → Menor</option>
            <option value="ASC">Menor → Mayor</option>
            <option value="AZ">A → Z</option>
          </select>
          <button id="btnReset" class="btn">Reiniciar</button>
        </div>

        <ul id="list" class="list"></ul>
        <div class="pager">
          <span id="pageInfo" style="color:var(--text-dim)"></span>
          <button class="btn" id="prev">Anterior</button>
          <button class="btn" id="next">Siguiente</button>
        </div>
      </div>
    </section>
  </main>
</div>

<div class="modal" id="modal">
  <div class="box">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 class="title" id="modalTitle">Detalles</h3>
      <button class="btn" id="modalClose">Cerrar</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxKd6a5ILT3qfbK91f4gvkHqKyRZWwoHFhYkVcHrGfHUyhr0v8gp1lWG9McrXs6rQIm/exec?webAction=get_all_data";
const ZONE = "America/Guatemala";
let STREAMS={}, ASIST=[];
const state={query:"",type:"all",month:"all",sort:"DESC",page:1,pageSize:15,rows:[]};

const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};
const showToast=m=>{const el=$('#toast');el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1500);};
const openModal=(t,h)=>{$('#modalTitle').textContent=t;$('#modalBody').innerHTML=h;$('#modal').classList.add('open');};
const closeModal=()=>$('#modal').classList.remove('open');
const playSFX=()=>{const s=$('#sfx');try{s.volume=0.25;s.currentTime=0;s.play();}catch(e){}};

$('#btnMenu').addEventListener('click',()=>$('#sidebar').classList.toggle('open'));
$('#btn-back').addEventListener('click',()=>show('cal'));
$('#nav-cal').addEventListener('click',()=>show('cal'));
$('#nav-top').addEventListener('click',()=>{buildTop();show('top');});

function show(v){
  $('#view-cal').classList.toggle('active',v==='cal');
  $('#view-top').classList.toggle('active',v==='top');
  $('#nav-cal').classList.toggle('active',v==='cal');
  $('#nav-top').classList.toggle('active',v==='top');
}

async function loadData(){
  try{
    const res=await fetch(API_URL+"&_="+Date.now());
    const json=await res.json();
    STREAMS=json.streams||{};
    ASIST=(json.asistencia||[]).filter(r=>{
      const fecha=r[0],user=r[1],tipo=r[2];
      if(!user||!String(user).trim())return false;
      if(!['normal','tarde','extra'].includes(tipo))return false;
      if(!fecha||isNaN(Date.parse(fecha)))return false;
      return true;
    });
  }catch(e){console.warn("Error al cargar datos",e);}
}

let calendar;
function initCalendar(){
  const el=$('#calendar');
  if(calendar){try{calendar.destroy();}catch(e){}}
  calendar=new FullCalendar.Calendar(el,{
    height:'100%',expandRows:true,initialView:'dayGridMonth',locale:'es',timeZone:ZONE,
    headerToolbar:{left:'prev,next today',center:'title',right:''},
    dayCellDidMount(info){const iso=info.date.toISOString().split('T')[0];if(STREAMS[iso])info.el.classList.add('fc-day-with-stream');},
    dateClick(info){
      const f=info.dateStr;if(!STREAMS[f])return;
      const list=ASIST.filter(a=>new Date(a[0]).toISOString().split('T')[0]===f);
      const html=list.length?`<ul class="modalList">${list.map(a=>`<li><span class="mUser">${a[1]}</span><span class="mTipo">${a[2]}</span></li>`).join("")}</ul>`:'<p>Sin registros.</p>';
      openModal(`Asistencias — ${f}`,html);playSFX();
    }
  });calendar.render();
}

function recolorCalendarDays(){
  $$('.fc-daygrid-day').forEach(c=>c.classList.remove('fc-day-with-stream'));
  $$('.fc-daygrid-day').forEach(cell=>{const d=cell.getAttribute('data-date');if(d&&STREAMS[d])cell.classList.add('fc-day-with-stream');});
}

const $search=$('#search'),$type=$('#type'),$month=$('#month'),$sort=$('#sort'),
$list=$('#list'),$pageInfo=$('#pageInfo'),$prev=$('#prev'),$next=$('#next'),$btnReset=$('#btnReset');

$search.addEventListener('input',debounce(()=>{state.query=$search.value.trim().toLowerCase();state.page=1;renderTop();},200));
$type.addEventListener('change',()=>{state.type=$type.value;state.page=1;buildTop();});
$month.addEventListener('change',()=>{state.month=$month.value;state.page=1;buildTop();showToast('Filtro de mes aplicado');});
$sort.addEventListener('change',()=>{state.sort=$sort.value;state.page=1;renderTop();});
$btnReset.addEventListener('click',()=>{$search.value='';$type.value='all';$month.value='all';$sort.value='DESC';Object.assign(state,{query:'',type:'all',month:'all',sort:'DESC',page:1});buildTop();showToast('Filtros reiniciados');});
$prev.addEventListener('click',()=>{if(state.page>1){state.page--;renderTop();}});
$next.addEventListener('click',()=>{const max=Math.ceil(state.rows.length/state.pageSize)||1;if(state.page<max){state.page++;renderTop();}});

function buildTop(){
  const filtered=ASIST.filter(r=>{
    const f=new Date(r[0]);
    if(state.type!=='all'&&r[2]!==state.type)return false;
    if(state.month!=='all'&&(f.getMonth()+1)!=state.month)return false;
    return true;
  });
  const counts=new Map();
  for(const r of filtered){const u=r[1];counts.set(u,(counts.get(u)||0)+1);}
  state.rows=Array.from(counts.entries()).map(([user,count])=>({user,count}));
  renderTop();
}

function renderTop(){
  let rows=state.rows.slice();
  if(state.query)rows=rows.filter(r=>r.user.toLowerCase().includes(state.query));
  if(state.sort==='DESC')rows.sort((a,b)=>b.count-a.count);
  if(state.sort==='ASC')rows.sort((a,b)=>a.count-b.count);
  if(state.sort==='AZ')rows.sort((a,b)=>a.user.localeCompare(b.user));
  const total=rows.length,maxPage=Math.max(1,Math.ceil(total/state.pageSize));
  if(state.page>maxPage)state.page=maxPage;
  const start=(state.page-1)*state.pageSize,end=start+state.pageSize;
  const pageRows=rows.slice(start,end);
  $list.innerHTML=pageRows.length?pageRows.map(r=>`<li><span class="badge">${r.user}</span><span class="count">${r.count}</span></li>`).join(''):'<li style="text-align:center;color:var(--text-dim)">Sin resultados</li>';
  $pageInfo.textContent=`Página ${state.page} / ${maxPage} — ${total} usuarios`;
}

document.addEventListener('DOMContentLoaded',async()=>{
  await loadData();initCalendar();buildTop();
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
  setInterval(async()=>{await loadData();recolorCalendarDays();if($('#view-top').classList.contains('active'))buildTop();},30000);
});
$('#modalClose').addEventListener('click',closeModal);
$('#modal').addEventListener('click',e=>{if(e.target.id==='modal')closeModal();});
</script>
</body>
</html>
