<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Asistencia Abdara12</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>

<style>
:root{
  --font-title:'UnifrakturCook',cursive;
  --font-body:'Roboto',sans-serif;

  --deep:#080808;
  --mid:#101010;
  --card:#151515;
  --b:#262626;

  --t:#ededed;
  --td:#a9a9a9;

  --p:#8d3aff;
  --k:#ff38c7;
  --d:#3a0061;

  --ok:#00ff9d;
  --warn:#ffe256;
  --info:#00b7ff;

  --H:70px;
  --W:260px;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overscroll-behavior:none}
body{font-family:var(--font-body);background:var(--deep);color:var(--t);overflow:hidden}

#app{
  display:grid;
  grid-template-columns:var(--W) 1fr;
  grid-template-rows:var(--H) 1fr;
  grid-template-areas:"h h" "s m";
  height:100vh;
}

header{
  grid-area:h;
  display:flex;
  align-items:center;
  gap:10px;
  padding:0 14px;
  background:var(--mid);
  border-bottom:1px solid var(--b);
}

#btnMenu{
  display:none;
  width:36px;height:36px;
  border-radius:8px;border:1px solid var(--b);
  background:#131313;color:white;
  cursor:pointer;
}

.title{
  font-family:var(--font-title);
  font-size:clamp(1.6rem,2.4vw+1rem,2.8rem);
  color:#dcd0ff;
  background:linear-gradient(90deg,var(--p),var(--k));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  filter:drop-shadow(0 0 6px rgba(141,58,255,.6)) drop-shadow(0 0 14px rgba(255,56,199,.35));
}

aside{
  grid-area:s;
  padding:16px;
  background:var(--mid);
  border-right:1px solid var(--b);
}

aside h2{
  font-family:var(--font-title);
  font-size:1.6rem;
  text-align:center;
  color:var(--p);
  text-shadow:0 0 10px var(--p);
  margin-bottom:10px;
}

.nav{list-style:none;display:flex;flex-direction:column;gap:10px;}
.nav a{
  display:block;
  padding:10px;
  background:#131313;
  border:1px solid var(--b);
  border-radius:10px;
  color:var(--td);
  text-decoration:none;
  cursor:pointer;
  transition:.25s;
}
.nav a:hover,.nav a.active{
  color:white;
  background:var(--d);
  box-shadow:0 0 14px var(--p);
}

main{
  grid-area:m;
  position:relative;
  padding:16px;
  height:calc(100vh - var(--H));
  overflow:hidden;
  background:
    radial-gradient(1200px 800px at 20% -20%,rgba(141,58,255,.12),transparent 60%),
    radial-gradient(1200px 800px at 120% 20%,rgba(255,56,199,.12),transparent 60%);
}

.card{
  height:100%;
  background:var(--card);
  border:1px solid var(--b);
  border-radius:14px;
  padding:16px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.02),0 0 24px rgba(141,58,255,.08);
}

.view{display:none;height:100%}
.view.active{display:block;animation:fade .25s ease}

#calendarWrap{height:100%;display:flex;flex-direction:column}
#calendar{flex:1;min-height:0}

/* FC */
.fc{--fc-border-color:var(--b)}
.fc .fc-toolbar-title{
  font-family:var(--font-title);
  color:#fff;
  text-shadow:0 0 12px var(--p);
}
.fc .fc-button{
  background:var(--d)!important;
  border:none!important;
  color:#fff!important;
  transition:.25s;
}
.fc .fc-button:hover{background:var(--p)!important;box-shadow:0 0 12px var(--p)}
.fc .fc-daygrid-day-number{color:var(--t)}
.fc .fc-col-header-cell-cushion{color:var(--td)}
.fc-theme-standard td,.fc-theme-standard th{border-color:var(--b)}
.fc-day-today{background:#1a1220!important}

.fc-day-with-stream{
  background:#2a0047!important;
  transition:.25s;
}
.fc-day-with-stream:hover{
  background:#43007a!important;
  box-shadow:inset 0 0 12px var(--p);
}

/* top */
.controls{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px}
.list{
  list-style:none;
  display:grid;
  grid-template-columns:1fr auto;
  row-gap:8px;
  column-gap:12px;
  padding:0;
  max-height:calc(100% - 140px);
  overflow:auto;
}
.list li{padding:8px 0;border-bottom:1px dashed var(--b)}
.badge{font-weight:700}
.count{color:var(--k)}

.pager{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}
.input,.select{
  background:#131313;
  border:1px solid var(--b);
  color:white;
  padding:8px 12px;
  border-radius:10px;
  outline:none;
}
.btn{
  background:var(--d);
  border:1px solid var(--p);
  color:white;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  transition:.25s;
}
.btn:hover{
  background:var(--p);
  box-shadow:0 0 12px var(--p);
}

/* modal */
.modal{
  position:fixed;inset:0;
  display:none;place-items:center;
  background:rgba(0,0,0,.5);
  backdrop-filter:blur(3px);
  z-index:100;
}
.modal.open{display:grid;animation:fade .25s ease}
.box{
  width:min(700px,90vw);
  max-height:80vh;
  overflow:auto;
  background:var(--card);
  border-radius:14px;
  padding:16px;
  border:1px solid var(--b);
  box-shadow:0 0 24px rgba(141,58,255,.25);
}

/* toast */
.toast{
  position:fixed;
  right:14px;bottom:14px;
  background:#141414;
  border:1px solid var(--b);
  color:white;
  padding:10px 14px;
  border-radius:10px;
  box-shadow:0 0 14px rgba(141,58,255,.25);
  opacity:0;
  transform:translateY(10px);
  transition:.25s;
  z-index:110;
}
.toast.show{opacity:1;transform:none}

@keyframes fade{from{opacity:0}to{opacity:1}}

@media(max-width:900px){
  :root{--W:0}
  #app{
    grid-template-columns:1fr;
    grid-template-areas:"h" "m";
  }
  aside{
    position:fixed;
    top:var(--H);
    left:0;bottom:0;
    width:250px;
    background:var(--mid);
    transform:translateX(-100%);
    transition:.25s;
    z-index:50;
  }
  aside.open{transform:none}
  #btnMenu{display:block}
}
</style>
</head>

<body>

<audio id="sfx" src="https://cdn.freesound.org/previews/656/656770_1648170-lq.mp3"></audio>

<div id="app">

<header>
  <button id="btnMenu">☰</button>
  <h1 class="title">Asistencia Abdara12</h1>
</header>

<aside id="sidebar">
  <h2>Menú</h2>
  <ul class="nav">
    <li><a id="nav-cal" class="active">Calendario</a></li>
    <li><a id="nav-top">Top Asistencias</a></li>
  </ul>
</aside>

<main>

<section id="view-cal" class="view active">
  <div id="calendarWrap" class="card">
    <div id="calendar"></div>
  </div>
</section>

<section id="view-top" class="view">
  <div class="card">
    <h2 class="title" style="font-size:2rem">Top Asistencias</h2>

    <div class="controls">
      <input id="search" class="input" placeholder="Buscar"/>
      <select id="type" class="select">
        <option value="all">Todos</option>
        <option value="normal">Normal</option>
        <option value="tarde">Tarde</option>
        <option value="extra">Extra</option>
      </select>
      <select id="sort" class="select">
        <option value="DESC">Mayor→Menor</option>
        <option value="ASC">Menor→Mayor</option>
        <option value="AZ">A→Z</option>
        <option value="ZA">Z→A</option>
      </select>
      <select id="pageSize" class="select">
        <option>10</option>
        <option selected>15</option>
        <option>25</option>
        <option>50</option>
      </select>
      <button id="btnReset" class="btn">Reset</button>
    </div>

    <ul id="list" class="list"></ul>

    <div class="pager">
      <span id="pageInfo"></span>
      <button class="btn" id="prev">←</button>
      <button class="btn" id="next">→</button>
    </div>

  </div>
</section>

</main>

</div>

<div class="modal" id="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="modalTitle" class="title">Detalles</h3>
      <button class="btn" id="modalClose">X</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbx6WjqODhuetXMwsAtzfvXY539Quj1exnRz7s7J6FQBH2UAlag6Brs6InxPsRS3uq2F/exec?webAction=get_all_data";
const TZ="America/Guatemala";

let STREAMS={};
let ASIST=[];

const $=x=>document.querySelector(x);

function toast(t){const e=$("#toast");e.textContent=t;e.classList.add("show");setTimeout(()=>e.classList.remove("show"),1200)}
function sfx(){const a=$("#sfx");try{a.volume=.3;a.currentTime=0;a.play()}catch(e){}}

async function load(){
  const r=await fetch(API+"&_="+Date.now());
  const j=await r.json();

  STREAMS=j.streams||{};

  ASIST=(j.asistencia||[]).filter(x=>{
    const f=x[0],u=x[1],t=x[2];
    if(!u||!u.trim())return false;
    if(!["normal","tarde","extra"].includes(t))return false;
    if(!f||isNaN(Date.parse(f)))return false;
    return true;
  });
}

let cal=null;
function calendarInit(){
  if(cal){try{cal.destroy()}catch(e){} cal=null}
  cal=new FullCalendar.Calendar($("#calendar"),{
    initialView:"dayGridMonth",
    timeZone:TZ,locale:"es",
    headerToolbar:{left:"prev,next today",center:"title"},
    dayCellDidMount(i){
      const d=i.date.toISOString().split("T")[0];
      if(STREAMS[d]) i.el.classList.add("fc-day-with-stream");
    },
    dateClick(i){
      const d=i.dateStr;
      if(!STREAMS[d])return;
      const list=ASIST.filter(a=>new Date(a[0]).toLocaleDateString("en-CA",{timeZone:TZ})===d);
      let html="";
      if(!list.length)html="<p>Sin registros.</p>";
      else{
        html="<ul style='list-style:none;padding:0;margin:0'>";
        for(const a of list){
          html+=`<li style="padding:6px 0;border-bottom:1px dashed #444"><b>${a[1]}</b> <span style="color:var(--k)">(${a[2]})</span></li>`;
        }
        html+="</ul>";
      }
      modal("Asistencias — "+d,html);
      sfx();
    }
  });
  cal.render();
}

/* MODAL */
function modal(t,h){$("#modalTitle").textContent=t;$("#modalBody").innerHTML=h;$("#modal").classList.add("open")}
$("#modalClose").onclick=()=>$("#modal").classList.remove("open");
$("#modal").onclick=e=>{if(e.target.id==="modal")$("#modal").classList.remove("open")}

/* TOP */
const list=$("#list");
const search=$("#search");
const type=$("#type");
const sort=$("#sort");
const pageSize=$("#pageSize");
const pageInfo=$("#pageInfo");
const prev=$("#prev");
const next=$("#next");
const btnReset=$("#btnReset");

let rows=[];
const S={q:"",t:"all",o:"DESC",p:1,ps:15};

function build(){
  const map=new Map();
  for(const r of ASIST){
    const u=r[1],tp=r[2];
    if(S.t==="all"||S.t===tp)map.set(u,(map.get(u)||0)+1);
  }
  rows=Array.from(map.entries()).map(([u,c])=>({u,c}));
  paint();
}

function paint(){
  let r=[...rows];

  if(S.q)r=r.filter(x=>x.u.toLowerCase().includes(S.q));

  if(S.o==="DESC")r.sort((a,b)=>b.c-a.c);
  if(S.o==="ASC")r.sort((a,b)=>a.c-b.c);
  if(S.o==="AZ")r.sort((a,b)=>a.u.localeCompare(b.u));
  if(S.o==="ZA")r.sort((a,b)=>b.u.localeCompare(a.u));

  const tot=r.length,mp=Math.max(1,Math.ceil(tot/S.ps));
  if(S.p>mp)S.p=mp;
  const st=(S.p-1)*S.ps,en=st+S.ps;
  const page=r.slice(st,en);

  list.innerHTML="";
  const frag=document.createDocumentFragment();
  for(const x of page){
    let a=document.createElement("li");
    a.innerHTML=`<span class="badge">${x.u}</span>`;
    let b=document.createElement("li");
    b.innerHTML=`<span class="count">${x.c}</span>`;
    frag.appendChild(a);frag.appendChild(b);
  }
  list.appendChild(frag);

  pageInfo.textContent=`${S.p}/${mp} — ${tot}`;
  list.scrollTo({top:0,behavior:"smooth"});
}

/* listeners */
search.oninput=()=>{S.q=search.value.toLowerCase();S.p=1;paint()}
type.onchange=()=>{S.t=type.value;S.p=1;build()}
sort.onchange=()=>{S.o=sort.value;S.p=1;paint()}
pageSize.onchange=()=>{S.ps=parseInt(pageSize.value);S.p=1;paint()}
prev.onclick=()=>{if(S.p>1){S.p--;paint()}}
next.onclick=()=>{S.p++;paint()}
btnReset.onclick=()=>{
  search.value="";S.q="";
  type.value="all";S.t="all";
  sort.value="DESC";S.o="DESC";
  pageSize.value="15";S.ps=15;
  S.p=1;build();toast("Reset")
}

/* nav */
$("#nav-cal").onclick=()=>page("cal")
$("#nav-top").onclick=()=>{page("top");sfx()}
function page(n){
  $("#nav-cal").classList.remove("active");
  $("#nav-top").classList.remove("active");
  $("#view-cal").classList.remove("active");
  $("#view-top").classList.remove("active");
  if(n==="cal"){$("#nav-cal").classList.add("active");$("#view-cal").classList.add("active")}
  else{$("#nav-top").classList.add("active");$("#view-top").classList.add("active");build()}
  $("#sidebar").classList.remove("open");
}

/* mobile */
$("#btnMenu").onclick=()=>$("#sidebar").classList.toggle("open")

/* INIT */
(async()=>{
  await load();
  calendarInit();
  setInterval(load,30000);
})();
</script>
</body>
</html>
