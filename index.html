<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistencia Abdara12</title>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>

<style>
/* ================= ROOT COLORS ================= */
:root{
    --font-title: 'UnifrakturCook', cursive;
    --font-body: 'Roboto', sans-serif;

    --bg-deep: #080808;
    --bg-mid: #111;
    --bg-card: #181818;
    --border: #282828;

    --text-primary: #e8e8e8;
    --text-secondary: #9c9c9c;

    --neon-purple: #8d3aff;
    --neon-pink: #ff38c7;
    --neon-dark: #3a0061;

    --green: #00ff8f;
    --yellow: #f0ff45;
    --blue: #00b7ff;
}

/* ================= RESET ================= */
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
}

body{
    height:100vh;
    background: var(--bg-deep);
    color:var(--text-primary);
    font-family:var(--font-body);
    overflow:hidden;
}

/* ================= GLOW FX ================= */
.neonGlow{
    text-shadow:
    0 0 4px var(--neon-purple),
    0 0 12px var(--neon-purple),
    0 0 24px var(--neon-pink);
}

/* ================= LAYOUT ================= */
#app{
    display:grid;
    grid-template-columns:240px 1fr;
    grid-template-rows:72px 1fr;
    grid-template-areas:
        "header header"
        "sidebar main";
    height:100%;
}

/* ================= HEADER ================= */
header{
    grid-area:header;
    display:flex;
    align-items:center;
    padding:0 24px;
    background:var(--bg-mid);
    border-bottom:1px solid var(--border);
}

header h1{
    font-family:var(--font-title);
    font-size:2.4rem;
    background:linear-gradient(90deg, var(--neon-purple), var(--neon-pink));
    -webkit-background-clip:text;
    color:transparent;
    text-shadow:0 0 10px var(--neon-purple);
    animation:fadeDown .7s ease;
}

/* ================= SIDEBAR ================= */
aside{
    grid-area:sidebar;
    padding:24px;
    background:var(--bg-mid);
    border-right:1px solid var(--border);
    animation:fadeLeft .6s ease;
}

aside h2{
    font-family:var(--font-title);
    text-align:center;
    color:var(--neon-purple);
    margin-bottom:12px;
    font-size:1.8rem;
    text-shadow:0 0 6px var(--neon-purple);
}

aside ul{
    list-style:none;
    margin-top:16px;
}

aside li a{
    display:block;
    padding:10px 14px;
    background:#131313;
    color:var(--text-secondary);
    border:1px solid var(--border);
    border-radius:6px;
    margin-bottom:10px;
    cursor:pointer;
    transition:.25s;
}

aside li a:hover{
    background:var(--neon-dark);
    color:white;
    box-shadow:0 0 12px var(--neon-purple);
}

/* ================= MAIN ================= */
main{
    grid-area:main;
    padding:28px;
    overflow-y:auto;
    background:var(--bg-deep);
    animation:fade .5s ease;
}

.card{
    background:var(--bg-card);
    border:1px solid var(--border);
    padding:20px;
    border-radius:10px;
    animation:fade .5s ease;
}

/* ================= FULLCALENDAR ================= */
.fc{
    --fc-border-color:var(--border);
}
.fc .fc-toolbar-title{
    color:var(--neon-purple);
    font-family:var(--font-title);
    text-shadow:0 0 10px var(--neon-purple);
}
.fc-button{
    background:var(--neon-dark) !important;
    border:none !important;
    color:white !important;
    transition:.3s;
}
.fc-button:hover{
    background:var(--neon-purple) !important;
    box-shadow:0 0 10px var(--neon-purple);
}
.fc-daygrid-day-number{
    color:var(--text-primary);
}
.fc-col-header-cell{
    color:var(--text-secondary);
}

/* DÍAS CON STREAM */
.fc-day-with-stream{
    background:#300052 !important;
    transition:.3s;
}
.fc-day-with-stream:hover{
    background:#52008a !important;
    box-shadow:inset 0 0 12px var(--neon-purple);
}

/* ================= ANIMACIONES ================= */
@keyframes fade{
    0%{ opacity:0; }
    100%{ opacity:1; }
}
@keyframes fadeLeft{
    0%{ opacity:0; transform:translateX(-40px); }
    100%{ opacity:1; transform:translateX(0); }
}
@keyframes fadeDown{
    0%{ opacity:0; transform:translateY(-30px); }
    100%{ opacity:1; transform:translateY(0); }
}
</style>
</head>

<body>

<audio id="sfx" src="https://cdn.freesound.org/previews/656/656770_1648170-lq.mp3"></audio>

<div id="app">

    <!-- HEADER -->
    <header>
        <h1 class="neonGlow">Calendario de Asistencia Abdara12</h1>
    </header>

    <!-- SIDEBAR -->
    <aside>
        <h2>Navegación</h2>
        <ul>
            <li><a id="link-calendario">Calendario</a></li>
            <li><a id="link-top">Top 3</a></li>
        </ul>
    </aside>

    <!-- MAIN -->
    <main>
        <div id="vista-calendario" class="card"></div>

        <div id="vista-detalles" class="card" style="display:none">
            <button id="volver">&larr; Volver</button>
            <h2 id="titulo-detalle"></h2>
            <ul id="listado"></ul>
        </div>

        <div id="vista-top" class="card" style="display:none">
            <button id="volverTop">&larr; Volver</button>
            <h2 class="neonGlow">Top 3 Asistencias</h2>
            <ul id="listaTop3"></ul>
        </div>

    </main>
</div>

<script>
/* ===================== CONFIG ===================== */
const API_URL =
"https://script.google.com/macros/s/AKfycbx6WjqODhuetXMwsAtzfvXY539Quj1exnRz7s7J6FQBH2UAlag6Brs6InxPsRS3uq2F/exec?webAction=get_all_data";
const ZONE = "America/Guatemala";
let DATOS_STREAM, DATOS_ASIST;

/* ===================== UTILS ===================== */
function show(id){
    document.getElementById("vista-calendario").style.display="none";
    document.getElementById("vista-detalles").style.display="none";
    document.getElementById("vista-top").style.display="none";
    document.getElementById(id).style.display="block";
}

/* ===================== SFX ===================== */
function playSFX(){
    const s = document.getElementById("sfx");
    s.volume = 0.35;
    s.currentTime = 0;
    s.play();
}

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded", ()=>{
    loadData();

    document.getElementById("link-calendario").onclick=()=>show("vista-calendario");
    document.getElementById("link-top").onclick=()=>{
        fillTop();
        show("vista-top");
        playSFX();
    };
    document.getElementById("volver").onclick=()=>show("vista-calendario");
    document.getElementById("volverTop").onclick=()=>show("vista-calendario");
});

/* ===================== GET DATA ===================== */
async function loadData(){
    const r = await fetch(API_URL);
    const d = await r.json();
    DATOS_STREAM = d.streams;
    DATOS_ASIST = d.asistencia;
    renderCalendar();
}

/* ===================== CALENDAR ===================== */
function renderCalendar(){
    const el = document.getElementById("vista-calendario");

    const calendar = new FullCalendar.Calendar(el,{
        initialView: "dayGridMonth",
        locale:"es",
        timeZone:ZONE,
        headerToolbar:{
            left:"prev,next today",
            center:"title",
            right:"dayGridMonth,timeGridWeek"
        },

        dayCellDidMount(arg){
            const f = arg.date.toISOString().split("T")[0];
            if(DATOS_STREAM[f]) arg.el.classList.add("fc-day-with-stream");
        },

        dateClick(info){
            const f = info.dateStr;
            if(!DATOS_STREAM[f]) return;

            const list = DATOS_ASIST.filter(a=>{
                const fa = new Date(a[0]).toLocaleDateString("en-CA",{timeZone:ZONE});
                return fa===f;
            });

            document.getElementById("titulo-detalle").innerText=`Asistencias ${f}`;
            const ul = document.getElementById("listado");
            ul.innerHTML="";

            list.length
            ? list.forEach(a=>{
                const li=document.createElement("li");
                li.textContent=`${a[1]} (${a[2]})`;
                ul.appendChild(li);
            })
            : ul.innerHTML="<li>Sin registros</li>";

            show("vista-detalles");
            playSFX();
        }
    });

    calendar.render();
}

/* ===================== TOP ===================== */
function fillTop(){
    const count={};
    DATOS_ASIST.forEach(r=>{
        if(r[2]==="normal" || r[2]==="tarde"){
            count[r[1]] = (count[r[1]]||0)+1;
        }
    });

    const top = Object.entries(count).sort((a,b)=>b[1]-a[1]).slice(0,3);
    const list = document.getElementById("listaTop3");
    list.innerHTML="";

    top.forEach(u=>{
        const li=document.createElement("li");
        li.textContent=`${u[0]} (${u[1]})`;
        list.appendChild(li);
    });
}
</script>

</body>
</html>
