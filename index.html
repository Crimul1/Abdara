<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Calendario de Asistencia Abdara12</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>

<style>
:root{
  --font-title:'UnifrakturCook',cursive; --font-body:'Roboto',sans-serif;
  --bg:#0a0a0a; --mid:#121212; --card:#161616; --border:#262626;
  --txt:#ededed; --dim:#a9a9a9; --pp:#8d3aff; --pk:#ff38c7; --dk:#30005b;
  --h:72px; --w:270px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:var(--font-body);background:var(--bg);color:var(--txt);overflow:hidden}
#app{display:grid;grid-template-columns:var(--w) 1fr;grid-template-rows:var(--h) 1fr;grid-template-areas:"h h" "s m";height:100vh}
header{grid-area:h;display:flex;align-items:center;gap:12px;padding:0 16px;background:var(--mid);border-bottom:1px solid var(--border)}
h1.title{font-family:var(--font-title);font-size:clamp(1.6rem,2.2vw+1rem,2.6rem);
  color:#e7dcff;background:linear-gradient(90deg,var(--pp),var(--pk));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
  filter:drop-shadow(0 0 6px rgba(141,58,255,.6)) drop-shadow(0 0 14px rgba(255,56,199,.35))}
aside{grid-area:s;padding:16px;background:var(--mid);border-right:1px solid var(--border)}
aside h2{font-family:var(--font-title);font-size:1.5rem;color:var(--pp)}
.nav{list-style:none;display:flex;flex-direction:column;gap:10px;margin-top:10px}
.nav a{display:block;padding:10px 14px;background:#131313;border:1px solid var(--border);border-radius:10px;color:var(--dim);text-decoration:none;cursor:pointer;transition:.25s}
.nav a:hover,.nav a.active{background:var(--dk);color:#fff;box-shadow:0 0 12px var(--pp)}
main{grid-area:m;position:relative;padding:16px;height:calc(100vh - var(--h));overflow:hidden;background:
  radial-gradient(900px 700px at 10% -10%,rgba(141,58,255,.12),transparent 60%),
  radial-gradient(900px 700px at 110% 0%,rgba(255,56,199,.12),transparent 60%)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02), 0 0 24px rgba(141,58,255,.08)}
.view{display:none;height:100%}
.view.active{display:block;animation:fade .25s ease}
#calendarWrap{height:100%;display:flex;flex-direction:column}
#calendar{flex:1;min-height:0}
.fc{--fc-border-color:var(--border)}
.fc .fc-toolbar-title{font-family:var(--font-title);color:#fff;text-shadow:0 0 10px var(--pp)}
.fc .fc-button{background:var(--dk)!important;border:none!important;color:#fff!important;transition:.2s}
.fc .fc-button:hover{background:var(--pp)!important;box-shadow:0 0 10px var(--pp)}
.fc .fc-daygrid-day-number{color:var(--txt)}
.fc .fc-col-header-cell-cushion{color:var(--dim)}
.fc-theme-standard td,.fc-theme-standard th{border-color:var(--border)}
.fc-day-today{background:#1a1220!important}
.fc-day-with-stream{background:#240146!important;transition:.2s}
.fc-day-with-stream:hover{background:#43007a!important;box-shadow:inset 0 0 12px var(--pp)}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
.input,.select,.btn{background:#131313;border:1px solid var(--border);color:#fff;padding:8px 12px;border-radius:10px}
.btn{cursor:pointer;transition:.2s}
.btn:hover{background:var(--pp);box-shadow:0 0 10px var(--pp)}
.list{list-style:none;display:grid;grid-template-columns:1fr auto;row-gap:8px;column-gap:12px;padding:0;max-height:calc(100% - 140px);overflow:auto}
.list li{padding:10px 0;border-bottom:1px dashed var(--border)}
.count{color:var(--pk)}
.pager{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);z-index:50}
.modal.open{display:grid;animation:fade .2s ease}
.modal .box{width:min(720px,92vw);max-height:80vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 0 24px rgba(141,58,255,.25)}
.toast{position:fixed;right:16px;bottom:16px;background:#141414;border:1px solid var(--border);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 0 14px rgba(141,58,255,.25);opacity:0;transform:translateY(10px);transition:.25s;z-index:60}
.toast.show{opacity:1;transform:none}
.skel{height:14px;background:#1c1c1c;border-radius:6px;overflow:hidden;position:relative}
.skel::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);animation:sh 1.2s infinite}
@keyframes sh{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
@keyframes fade{from{opacity:0}to{opacity:1}}
@media (max-width:920px){
  :root{--w:0}
  #app{grid-template-columns:1fr;grid-template-areas:"h" "m"}
  aside{display:none}
}
</style>
</head>
<body>

<div id="app">
  <header>
    <h1 class="title" data-text="Calendario de Asistencia Abdara12">Calendario de Asistencia Abdara12</h1>
  </header>

  <aside>
    <h2>Menú</h2>
    <ul class="nav">
      <li><a id="nav-cal" class="active">Calendario</a></li>
      <li><a id="nav-top">Top Asistencias</a></li>
    </ul>
  </aside>

  <main>
    <!-- CALENDARIO -->
    <section id="view-cal" class="view active">
      <div class="card" style="height:100%;display:flex;flex-direction:column;gap:10px">
        <div class="controls" style="justify-content:space-between">
          <div><span style="color:var(--dim)">Días con stream se iluminan.</span></div>
          <div>
            <button id="btnRefresh" class="btn">Actualizar</button>
          </div>
        </div>
        <div id="calendarWrap" class="card" style="flex:1">
          <div id="calendar" aria-label="Calendario"></div>
        </div>
      </div>
    </section>

    <!-- TOP ASISTENCIAS -->
    <section id="view-top" class="view">
      <div class="card" style="height:100%;display:flex;flex-direction:column">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
          <h2 class="title" data-text="Top Asistencias">Top Asistencias</h2>
          <div style="display:flex;gap:8px">
            <button class="btn" id="btnBack">&larr; Volver</button>
            <button class="btn" id="btnRefresh2">Actualizar</button>
          </div>
        </div>

        <div class="controls">
          <input id="search" class="input" placeholder="Buscar usuario" />
          <select id="sort" class="select">
            <option value="DESC">Mayor → Menor</option>
            <option value="ASC">Menor → Mayor</option>
            <option value="AZ">Nombre A → Z</option>
            <option value="ZA">Nombre Z → A</option>
          </select>
          <select id="pageSize" class="select">
            <option value="10">10 por página</option>
            <option value="15" selected>15 por página</option>
            <option value="25">25 por página</option>
            <option value="50">50 por página</option>
          </select>
        </div>

        <ul id="list" class="list" aria-live="polite"></ul>

        <div class="pager">
          <span id="pageInfo" style="color:var(--dim)"></span>
          <button class="btn" id="prev">Anterior</button>
          <button class="btn" id="next">Siguiente</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px">
      <h3 class="title" id="modalTitle" data-text="Detalles"></h3>
      <button class="btn" id="modalClose">Cerrar</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx6WjqODhuetXMwsAtzfvXY539Quj1exnRz7s7J6FQBH2UAlag6Brs6InxPsRS3uq2F/exec?webAction=get_all_data";
const ZONE = "America/Guatemala";

let DATA = { asistencia: [], streams: {} };
let calendar;
const state = { query:"", sort:"DESC", page:1, pageSize:15, rows:[] };

const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);

function toast(msg){const t=$("#toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1200);}

function hasStream(dateISO){
  const d = DATA.streams?.[dateISO];
  // marcar sólo si existe startTimeUTC (no marcar si el sheet quedó vacío)
  return d && typeof d.startTimeUTC === "string" && d.startTimeUTC.length>0;
}

async function fetchData(){
  // cache-busting & robustez ante hojas vacías
  const url = API_URL + "&t=" + Date.now();
  const r = await fetch(url, {cache:"no-store"});
  const j = await r.json().catch(()=>({asistencia:[],streams:{}}));

  // Sanitizar: quitar filas malas/headers/usuarios vacíos
  const asistencia = Array.isArray(j.asistencia)? j.asistencia.filter(row=>{
    if(!row || row.length<3) return false;
    const ts=row[0], user=row[1], tipo=row[2];
    if(!user || typeof user!=="string" || user.trim()==="") return false;
    if(!ts || typeof ts!=="string") return false;
    if(!["normal","tarde","extra"].includes(String(tipo))) return false;
    return true;
  }):[];

  const streams = (j.streams && typeof j.streams==="object") ? j.streams : {};

  DATA = { asistencia, streams };
}

function destroyCalendar(){ if(calendar){ try{ calendar.destroy(); }catch(e){} calendar=null; } }

function renderCalendar(){
  destroyCalendar();
  const el = $("#calendar");
  calendar = new FullCalendar.Calendar(el, {
    height:"100%", expandRows:true, initialView:"dayGridMonth",
    locale:"es", timeZone: ZONE,
    headerToolbar:{ left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek" },
    dayCellDidMount(info){
      const dateISO = info.date.toISOString().split("T")[0];
      if(hasStream(dateISO)){ info.el.classList.add("fc-day-with-stream"); }
    },
    dateClick(info){
      const dateISO = info.dateStr;
      if(!hasStream(dateISO)) return; // no hacer nada si no hubo stream

      const list = DATA.asistencia.filter(a=>{
        const fa = new Date(a[0]).toLocaleDateString("en-CA",{timeZone:ZONE});
        return fa===dateISO;
      });

      const html = list.length
        ? `<ul style="list-style:none;padding:0;margin:0">
            ${list.map(a=>`<li style="padding:8px 0;border-bottom:1px dashed var(--border)">
               <b>${a[1]}</b> <span style="color:#ff38c7">(${a[2]})</span>
             </li>`).join("")}
           </ul>`
        : `<div class="skel" style="width:100%"></div><p style="margin-top:8px;color:var(--dim)">Sin registros para este día.</p>`;

      $("#modalTitle").textContent = `Asistencias — ${dateISO}`;
      $("#modal").classList.add("open");
      $("#modalBody").innerHTML = html;
    }
  });
  calendar.render();
}

function buildTopRows(){
  // contar solo normal+tarde
  const cnt = new Map();
  for(const r of DATA.asistencia){
    const user = r[1], tipo = r[2];
    if(tipo==="normal"||tipo==="tarde"){
      cnt.set(user, (cnt.get(user)||0)+1);
    }
  }
  state.rows = Array.from(cnt.entries()).map(([user,count])=>({user,count}));
}

function renderTop(){
  let rows = state.rows.slice();

  // filtro por nombre
  if(state.query){ rows = rows.filter(r=> r.user.toLowerCase().includes(state.query)); }

  // orden
  if(state.sort==="DESC") rows.sort((a,b)=>b.count-a.count);
  if(state.sort==="ASC") rows.sort((a,b)=>a.count-b.count);
  if(state.sort==="AZ")  rows.sort((a,b)=>a.user.localeCompare(b.user));
  if(state.sort==="ZA")  rows.sort((a,b)=>b.user.localeCompare(a.user));

  const total = rows.length;
  const maxPage = Math.max(1, Math.ceil(total/state.pageSize));
  if(state.page>maxPage) state.page=maxPage;
  const start=(state.page-1)*state.pageSize, end=start+state.pageSize;
  const pageRows = rows.slice(start,end);

  const listEl = $("#list");
  listEl.innerHTML="";
  if(pageRows.length===0){
    listEl.innerHTML = `<li style="grid-column:1/-1;color:var(--dim)">Sin datos</li>`;
  }else{
    const frag=document.createDocumentFragment();
    for(const r of pageRows){
      const li1=document.createElement("li"); li1.innerHTML=`<b>${r.user}</b>`;
      const li2=document.createElement("li"); li2.innerHTML=`<span class="count">${r.count}</span>`;
      frag.appendChild(li1); frag.appendChild(li2);
    }
    listEl.appendChild(frag);
  }
  $("#pageInfo").textContent=`Página ${state.page} / ${maxPage} — ${total} usuarios`;
  listEl.scrollTop=0;
}

function show(view){
  $("#view-cal").classList.remove("active");
  $("#view-top").classList.remove("active");
  if(view==="cal") $("#view-cal").classList.add("active");
  if(view==="top") $("#view-top").classList.add("active");
}

async function refreshAll(silent=false){
  await fetchData();            // lee HOJA ACTUAL
  renderCalendar();             // repinta calendario con lo nuevo
  buildTopRows();               // recalcula top
  if($("#view-top").classList.contains("active")) renderTop();
  if(!silent) toast("Datos actualizados");
}

// UI
document.addEventListener("DOMContentLoaded", async ()=>{
  // cargar
  await refreshAll(true);

  // auto-update cada 30s
  setInterval(()=>refreshAll(true), 30000);

  // nav
  $("#nav-cal").onclick=()=>{ show("cal"); $("#nav-cal").classList.add("active"); $("#nav-top").classList.remove("active"); };
  $("#nav-top").onclick=()=>{ show("top"); $("#nav-top").classList.add("active"); $("#nav-cal").classList.remove("active"); renderTop(); };

  // botones
  $("#btnBack").onclick=()=>show("cal");
  $("#btnRefresh").onclick=()=>refreshAll();
  $("#btnRefresh2").onclick=()=>refreshAll();

  // top controls
  $("#search").addEventListener("input", (e)=>{ state.query=(e.target.value||"").toLowerCase(); state.page=1; renderTop(); });
  $("#sort").addEventListener("change", (e)=>{ state.sort=e.target.value; state.page=1; renderTop(); });
  $("#pageSize").addEventListener("change", (e)=>{ state.pageSize=parseInt(e.target.value,10); state.page=1; renderTop(); });
  $("#prev").onclick=()=>{ if(state.page>1){ state.page--; renderTop(); } };
  $("#next").onclick=()=>{ state.page++; renderTop(); };

  // modal
  $("#modalClose").onclick=()=>$("#modal").classList.remove("open");
  $("#modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") $("#modal").classList.remove("open"); });
});
</script>
</body>
</html>
